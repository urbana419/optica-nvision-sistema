<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Central - Óptica Nvisión</title>
    
    <!-- Firebase CDN -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            min-height: 100vh; 
            color: white; 
            padding: 15px;
        }
        .container { max-width: 500px; margin: 0 auto; }
        
        .header {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 25px;
            padding: 25px;
            text-align: center;
            margin-bottom: 25px;
        }
        
        .header h1 {
            font-size: 26px;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #fbbf24, #f59e0b);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .by-line {
            font-size: 11px;
            opacity: 0.7;
            margin-top: 10px;
            color: #e2e8f0;
        }
        
        .connection-status {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-top: 15px;
            padding: 10px;
            border-radius: 15px;
            font-size: 14px;
            font-weight: 600;
        }
        
        .status-online {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
            border: 1px solid rgba(16, 185, 129, 0.3);
        }
        
        .status-offline {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }
        
        .main-sections {
            display: grid;
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .section-card {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            padding: 20px;
        }
        
        .section-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 15px;
            text-align: center;
            color: #fbbf24;
        }
        
        .feature-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }
        
        .feature-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            padding: 15px 10px;
            border-radius: 15px;
            font-size: 13px;
            font-weight: 700;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s ease;
            touch-action: manipulation;
        }
        
        .feature-btn:hover, .feature-btn:active {
            background: rgba(255, 255, 255, 0.25);
            transform: translateY(-2px);
        }
        
        .btn-primary {
            background: linear-gradient(45deg, #22d3ee, #0891b2);
        }
        
        .btn-success {
            background: linear-gradient(45deg, #10b981, #059669);
        }
        
        .btn-warning {
            background: linear-gradient(45deg, #f59e0b, #d97706);
        }
        
        .btn-danger {
            background: linear-gradient(45deg, #ef4444, #dc2626);
        }
        
        .emergency-section {
            background: linear-gradient(45deg, #ef4444, #dc2626);
            border-radius: 25px;
            padding: 25px;
            text-align: center;
            margin-bottom: 20px;
            animation: pulse-emergency 2s infinite;
            cursor: pointer;
            touch-action: manipulation;
        }
        
        @keyframes pulse-emergency {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }
        
        .emergency-icon {
            font-size: 50px;
            margin-bottom: 15px;
        }
        
        .emergency-text {
            font-size: 20px;
            font-weight: 900;
            margin-bottom: 10px;
        }
        
        .templates-grid {
            display: grid;
            gap: 10px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .template-item {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.2);
            touch-action: manipulation;
        }
        
        .template-item:hover, .template-item:active {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .template-title {
            font-weight: 700;
            color: #60a5fa;
            margin-bottom: 5px;
            font-size: 14px;
        }
        
        .template-preview {
            font-size: 12px;
            opacity: 0.9;
            line-height: 1.3;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            overflow-y: auto;
        }
        
        .modal-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 20px auto;
            padding: 25px;
            border-radius: 25px;
            max-width: 450px;
            position: relative;
        }
        
        .modal-close {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 28px;
            cursor: pointer;
            color: white;
            touch-action: manipulation;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #e2e8f0;
            font-size: 14px;
        }
        
        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border-radius: 10px;
            font-size: 16px;
            font-family: inherit;
        }
        
        .form-input::placeholder, .form-textarea::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }
        
        .btn {
            padding: 15px 20px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin-bottom: 10px;
            touch-action: manipulation;
        }
        
        .camera-upload {
            background: rgba(255, 255, 255, 0.1);
            border: 2px dashed rgba(255, 255, 255, 0.3);
            border-radius: 15px;
            padding: 30px 15px;
            text-align: center;
            cursor: pointer;
            margin-bottom: 15px;
            transition: all 0.3s ease;
            touch-action: manipulation;
        }
        
        .camera-upload:hover, .camera-upload:active {
            background: rgba(255, 255, 255, 0.15);
            border-color: #22d3ee;
        }
        
        .camera-icon {
            font-size: 40px;
            margin-bottom: 10px;
            display: block;
        }
        
        .preview-image {
            max-width: 100%;
            width: 100%;
            height: auto;
            max-height: 300px;
            border-radius: 10px;
            margin-top: 15px;
            object-fit: cover;
        }
        
        .alert {
            background: rgba(34, 211, 238, 0.2);
            border: 1px solid rgba(34, 211, 238, 0.3);
            color: #22d3ee;
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 15px;
            text-align: center;
            font-weight: 600;
            font-size: 14px;
        }
        
        .alert-success {
            background: rgba(16, 185, 129, 0.2);
            border-color: rgba(16, 185, 129, 0.3);
            color: #10b981;
        }
        
        .alert-error {
            background: rgba(239, 68, 68, 0.2);
            border-color: rgba(239, 68, 68, 0.3);
            color: #ef4444;
        }
        
        .navigation-buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-top: 20px;
        }
        
        .nav-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 12px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s ease;
            touch-action: manipulation;
        }
        
        .nav-btn:hover, .nav-btn:active {
            background: rgba(255, 255, 255, 0.3);
        }
        
        /* Específico para móviles */
        @media (max-width: 480px) {
            .container { padding: 10px; }
            .header { padding: 20px; }
            .header h1 { font-size: 22px; }
            .feature-btn { padding: 12px 8px; font-size: 12px; }
            .emergency-text { font-size: 18px; }
            .form-input, .form-select, .form-textarea { font-size: 16px; }
        }
        
        /* Mejorar scroll en móviles */
        ::-webkit-scrollbar {
            width: 6px;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🎯 Central Óptica Nvisión</h1>
            <p>Sistema Centralizado de Gestión</p>
            <div class="by-line">by fbrugaljrubinstein consultores</div>
            
            <div id="connectionStatus" class="connection-status status-offline">
                <span id="statusIcon">🔴</span>
                <span id="statusText">Configurando Firebase...</span>
            </div>
        </div>

        <div id="alertContainer"></div>

        <!-- EMERGENCIA SIEMPRE VISIBLE -->
        <div class="emergency-section" onclick="activarEmergencia()">
            <div class="emergency-icon">🚨</div>
            <div class="emergency-text">EMERGENCIA OCULAR</div>
            <div style="font-size: 14px;">Toque para llamada inmediata</div>
        </div>

        <div class="main-sections">
            <!-- ACCESO A SISTEMAS PRINCIPALES -->
            <div class="section-card">
                <h2 class="section-title">🏥 Sistemas Principales</h2>
                <div class="feature-grid">
                    <button onclick="goToIndex()" class="feature-btn btn-primary">
                        🏠 Inicio<br><small>Sistema principal</small>
                    </button>
                    <button onclick="goToAdmin()" class="feature-btn btn-success">
                        ⚙️ Administración<br><small>Gestión completa</small>
                    </button>
                    <button onclick="goToPOS()" class="feature-btn btn-warning">
                        💼 Punto de Venta<br><small>Facturación NCF</small>
                    </button>
                    <button onclick="abrirModalTestVisual()" class="feature-btn btn-danger">
                        👁️ Test Visual<br><small>Con voz guiada</small>
                    </button>
                </div>
            </div>

            <!-- WHATSAPP TEMPLATES -->
            <div class="section-card">
                <h2 class="section-title">💬 Plantillas WhatsApp</h2>
                <div class="templates-grid" id="templatesGrid">
                    <!-- Templates predefinidas -->
                    <div class="template-item" onclick="usarTemplate('promocion')">
                        <div class="template-title">🎁 Promoción Especial</div>
                        <div class="template-preview">👁️ ¡ÓPTICA NVISIÓN! 🎁 Promoción especial en monturas...</div>
                    </div>
                    <div class="template-item" onclick="usarTemplate('recordatorio')">
                        <div class="template-title">⏰ Recordatorio Cita</div>
                        <div class="template-preview">📅 Recordatorio: Su cita está programada para...</div>
                    </div>
                    <div class="template-item" onclick="usarTemplate('seguimiento')">
                        <div class="template-title">📋 Seguimiento Post-Venta</div>
                        <div class="template-preview">👁️ ¿Cómo está con sus nuevos lentes?...</div>
                    </div>
                    <div class="template-item" onclick="usarTemplate('proforma')">
                        <div class="template-title">📄 Factura Proforma Rural</div>
                        <div class="template-preview">🌾 Factura Proforma (Sin NCF) - Zona Rural/Humanitaria...</div>
                    </div>
                </div>
                <button onclick="abrirModalTemplate()" class="feature-btn btn-primary" style="margin-top: 15px;">
                    ➕ Nueva Plantilla
                </button>
            </div>

            <!-- MODO RURAL/HUMANITARIO -->
            <div class="section-card">
                <h2 class="section-title">🌾 Modo Rural/Humanitario</h2>
                <div class="feature-grid">
                    <button onclick="activarModoRural()" class="feature-btn btn-success">
                        🌾 Activar Modo<br><small>Para zonas rurales</small>
                    </button>
                    <button onclick="abrirModalAyuda()" class="feature-btn btn-warning">
                        🤝 Solicitar Ayuda<br><small>Asistencia remota</small>
                    </button>
                    <button onclick="abrirModalVoz()" class="feature-btn btn-primary">
                        🎤 Nota de Voz<br><small>Enviar audio</small>
                    </button>
                    <button onclick="compartirUbicacion()" class="feature-btn btn-danger">
                        📍 Mi Ubicación<br><small>Para emergencias</small>
                    </button>
                </div>
            </div>

            <!-- GESTIÓN RÁPIDA -->
            <div class="section-card">
                <h2 class="section-title">⚡ Acciones Rápidas</h2>
                <div class="feature-grid">
                    <button onclick="abrirModalInventario()" class="feature-btn btn-primary">
                        📦 Agregar Producto<br><small>Con foto</small>
                    </button>
                    <button onclick="abrirModalFacturacion()" class="feature-btn btn-success">
                        💰 Factura Rápida<br><small>NCF automático</small>
                    </button>
                    <button onclick="sincronizarTodo()" class="feature-btn btn-warning">
                        🔄 Sincronizar<br><small>Firebase + Local</small>
                    </button>
                    <button onclick="exportarDatos()" class="feature-btn btn-danger">
                        📤 Exportar<br><small>Backup completo</small>
                    </button>
                </div>
            </div>
        </div>

        <!-- NAVEGACIÓN A OTROS MÓDULOS -->
        <div class="navigation-buttons">
            <button onclick="goToIndex()" class="nav-btn">🏠 Inicio</button>
            <button onclick="goToAdmin()" class="nav-btn">⚙️ Admin</button>
            <button onclick="goToPOS()" class="nav-btn">💼 POS</button>
            <button onclick="resetSystem()" class="nav-btn">🔄 Reset</button>
        </div>
    </div>

    <!-- MODAL TEST VISUAL -->
    <div id="modalTestVisual" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="cerrarModal('modalTestVisual')">&times;</span>
            <h2 class="section-title">👁️ Test Visual Guiado</h2>
            
            <div id="testStepContainer">
                <div style="text-align: center; padding: 30px;">
                    <div style="font-size: 60px; margin-bottom: 20px;">👁️</div>
                    <div style="font-size: 18px; margin-bottom: 20px;">Test de vista con instrucciones de voz</div>
                    <button onclick="iniciarTestGuiado()" class="btn btn-primary">🎙️ Iniciar Test con Voz</button>
                    <button onclick="iniciarTestSilencioso()" class="btn btn-success">👀 Test Silencioso</button>
                    <button onclick="enviarTestPorWhatsApp()" class="btn btn-warning">💬 Enviar Test por WhatsApp</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL INVENTARIO -->
    <div id="modalInventario" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="cerrarModal('modalInventario')">&times;</span>
            <h2 class="section-title">📦 Nuevo Producto</h2>
            
            <div class="form-group">
                <label class="form-label">📸 Foto del Producto</label>
                <div class="camera-upload" onclick="tomarFotoProducto()">
                    <span class="camera-icon">📷</span>
                    <div>Tomar foto con cámara</div>
                    <img id="previewProducto" class="preview-image" style="display: none;">
                </div>
                <input type="file" id="inputFotoProducto" accept="image/*" capture="environment" style="display: none;">
            </div>
            
            <div class="form-group">
                <label class="form-label">🔤 Código del Producto</label>
                <input type="text" id="codigoProducto" class="form-input" placeholder="NV001, NV002..." style="text-transform: uppercase;">
            </div>
            
            <div class="form-group">
                <label class="form-label">📝 Descripción</label>
                <textarea id="descripcionProducto" class="form-textarea" rows="3" placeholder="Montura elegante para dama..."></textarea>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <div class="form-group">
                    <label class="form-label">💰 Precio</label>
                    <input type="text" id="precioProducto" class="form-input" placeholder="RD$2,500">
                </div>
                <div class="form-group">
                    <label class="form-label">📊 Stock</label>
                    <input type="number" id="stockProducto" class="form-input" placeholder="1" min="0">
                </div>
            </div>
            
            <button onclick="guardarProductoFirebase()" class="btn btn-primary">☁️ Guardar en Firebase</button>
            <button onclick="enviarProductoWhatsApp()" class="btn btn-success">💬 Enviar por WhatsApp</button>
        </div>
    </div>

    <!-- MODAL PLANTILLA WHATSAPP -->
    <div id="modalTemplate" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="cerrarModal('modalTemplate')">&times;</span>
            <h2 class="section-title">💬 Nueva Plantilla WhatsApp</h2>
            
            <div class="form-group">
                <label class="form-label">📝 Título de la Plantilla</label>
                <input type="text" id="tituloTemplate" class="form-input" placeholder="Ej: Promoción Lentes">
            </div>
            
            <div class="form-group">
                <label class="form-label">📂 Categoría</label>
                <select id="categoriaTemplate" class="form-select">
                    <option value="promocion">🎁 Promoción</option>
                    <option value="informativo">ℹ️ Informativo</option>
                    <option value="recordatorio">⏰ Recordatorio</option>
                    <option value="emergencia">🚨 Emergencia</option>
                    <option value="seguimiento">📋 Seguimiento</option>
                    <option value="proforma">🌾 Factura Proforma Rural</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">💬 Mensaje (con iconos)</label>
                <textarea id="mensajeTemplate" class="form-textarea" rows="6" placeholder="👁️ ¡ÓPTICA NVISIÓN! 👁️

🎁 Promoción especial...
💰 Precio: [PRECIO]
📱 Cliente: [CLIENTE]

✨ ¡Vea mejor, viva mejor!"></textarea>
            </div>
            
            <div class="form-group">
                <label class="form-label">🎯 Tipo de Uso</label>
                <select id="tipoTemplate" class="form-select">
                    <option value="individual">👤 Individual</option>
                    <option value="masivo">📢 Masivo</option>
                    <option value="automatico">🤖 Automático</option>
                </select>
            </div>
            
            <button onclick="guardarTemplate()" class="btn btn-primary">💾 Guardar Plantilla</button>
            <button onclick="previsualizarTemplate()" class="btn btn-success">👀 Previsualizar</button>
        </div>
    </div>

    <!-- MODAL FACTURACIÓN RÁPIDA -->
    <div id="modalFacturacion" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="cerrarModal('modalFacturacion')">&times;</span>
            <h2 class="section-title">💰 Facturación Rápida</h2>
            
            <div class="form-group">
                <label class="form-label">👤 Cliente</label>
                <input type="text" id="clienteFactura" class="form-input" placeholder="Nombre del cliente">
            </div>
            
            <div class="form-group">
                <label class="form-label">📱 Teléfono</label>
                <input type="tel" id="telefonoFactura" class="form-input" placeholder="849-000-0000">
            </div>
            
            <div class="form-group">
                <label class="form-label">📋 Tipo de Comprobante</label>
                <select id="tipoComprobanteFactura" class="form-select">
                    <option value="sin_ncf">🌾 Sin NCF (Zona Rural/Humanitario)</option>
                    <option value="consumidor">🧾 Consumidor Final</option>
                    <option value="empresarial">🏢 Empresarial</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">💰 Total</label>
                <input type="text" id="totalFactura" class="form-input" placeholder="RD$0.00">
            </div>
            
            <div class="form-group">
                <label class="form-label">📝 Descripción</label>
                <textarea id="descripcionFactura" class="form-textarea" rows="3" placeholder="Montura + lentes graduados..."></textarea>
            </div>
            
            <button onclick="generarFacturaRapida()" class="btn btn-primary">📄 Generar Factura</button>
            <button onclick="enviarProformaPorWhatsApp()" class="btn btn-success">💬 Enviar Proforma</button>
        </div>
    </div>

    <!-- MODAL NOTA DE VOZ -->
    <div id="modalVoz" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="cerrarModal('modalVoz')">&times;</span>
            <h2 class="section-title">🎤 Enviar Nota de Voz</h2>
            
            <div style="text-align: center; padding: 30px;">
                <div id="vozStatus" style="font-size: 18px; margin-bottom: 20px;">Listo para grabar</div>
                <div style="font-size: 80px; margin-bottom: 30px;" id="vozIcon">🎤</div>
                
                <button id="btnGrabar" onclick="iniciarGrabacion()" class="btn btn-danger">🔴 Iniciar Grabación</button>
                <button id="btnDetener" onclick="detenerGrabacion()" class="btn btn-warning" style="display: none;">⏹️ Detener</button>
                <button id="btnEnviar" onclick="enviarNotaVoz()" class="btn btn-success" style="display: none;">📤 Enviar por WhatsApp</button>
                
                <div style="margin-top: 20px;">
                    <audio id="audioPlayback" controls style="display: none; width: 100%;"></audio>
                </div>
            </div>
        </div>
    </div>

    <script>
        // CONFIGURACIÓN FIREBASE - REEMPLAZAR CON DATOS REALES
        const firebaseConfig = {
            // Configuración de ejemplo - debe reemplazarse
            apiKey: "AIzaSyC8example_key_replace_with_real",
            authDomain: "nvision-optica.firebaseapp.com",
            databaseURL: "https://nvision-optica-default-rtdb.firebaseio.com",
            projectId: "nvision-optica",
            storageBucket: "nvision-optica.appspot.com",
            messagingSenderId: "123456789",
            appId: "1:123456789:web:abcdef123456"
        };

        // VARIABLES GLOBALES
        var WHATSAPP_NUMBER = '18497972424';
        var BASE_URL = window.location.origin + window.location.pathname.replace(/[^/]*$/, '');
        var firebaseApp, database, storage, auth;
        var isFirebaseConnected = false;
        var currentPhotoBlob = null;
        var mediaRecorder = null;
        var audioChunks = [];
        var audioBlob = null;

        // CLASE PARA MANEJO DE COMPROBANTES NCF MEJORADA
        class ComprobanteNCF {
            constructor(tipo, inicial = 1, final = 99999) {
                this.tipo = tipo;
                this.actual = inicial;
                this.final = final;
                this.prefijo = this.getPrefijo(tipo);
            }
            
            getPrefijo(tipo) {
                const prefijos = {
                    'consumidor': 'B01',
                    'empresarial': 'B02',
                    'gubernamental': 'B03',
                    'zona_franca': 'B04'
                };
                return prefijos[tipo] || 'B01';
            }
            
            usar() {
                if (this.actual > this.final) {
                    throw new Error(`❌ No quedan comprobantes ${this.tipo}. Rango agotado.`);
                }
                const numero = this.prefijo + String(this.actual).padStart(11, '0');
                this.actual++;
                this.guardarEnFirebase();
                return numero;
            }
            
            obtenerSiguiente() {
                if (this.actual > this.final) {
                    return null;
                }
                return this.prefijo + String(this.actual).padStart(11, '0');
            }
            
            quedan() {
                return Math.max(0, this.final - this.actual + 1);
            }
            
            async guardarEnFirebase() {
                if (isFirebaseConnected && database) {
                    try {
                        await database.ref(`comprobantes/${this.tipo}`).set({
                            actual: this.actual,
                            final: this.final,
                            prefijo: this.prefijo,
                            ultimaActualizacion: new Date().toISOString()
                        });
                    } catch (error) {
                        console.error('Error guardando comprobante en Firebase:', error);
                        // Fallback a localStorage
                        this.guardarLocal();
                    }
                } else {
                    this.guardarLocal();
                }
            }
            
            guardarLocal() {
                try {
                    var comprobantes = safeGetStorage('nvision_comprobantes') || {};
                    comprobantes[this.tipo] = {
                        actual: this.actual,
                        final: this.final,
                        prefijo: this.prefijo
                    };
                    safeSetStorage('nvision_comprobantes', comprobantes);
                } catch (error) {
                    console.error('Error guardando comprobante local:', error);
                }
            }
        }

        // PLANTILLAS WHATSAPP PREDEFINIDAS
        const plantillasWhatsApp = {
            promocion: {
                titulo: "🎁 Promoción Especial",
                mensaje: `👁️ *ÓPTICA NVISIÓN* 👁️

🎁 *PROMOCIÓN ESPECIAL* 🎁
💰 Precio especial: [PRECIO]
👤 Para: [CLIENTE]
📱 Tel: [TELEFONO]

🔥 Oferta limitada en monturas premium
✨ Garantía de calidad
🚚 Entrega gratuita

👁️ ¡Vea mejor, viva mejor! ✨
by fbrugaljrubinstein consultores`
            },
            recordatorio: {
                titulo: "⏰ Recordatorio Cita",
                mensaje: `👁️ *ÓPTICA NVISIÓN* 👁️

⏰ *RECORDATORIO DE CITA* ⏰
👤 [CLIENTE]
📅 Fecha: [FECHA]
🕒 Hora: [HORA]

📍 Recuerde traer:
• Cédula de identidad
• Seguro médico (si aplica)
• Lentes actuales

📱 Para cambios: ${WHATSAPP_NUMBER}
👁️ ¡Vea mejor, viva mejor! ✨`
            },
            seguimiento: {
                titulo: "📋 Seguimiento Post-Venta",
                mensaje: `👁️ *ÓPTICA NVISIÓN* 👁️

📋 *SEGUIMIENTO POST-VENTA* 📋
👤 [CLIENTE]

❓ ¿Cómo está con sus nuevos lentes?
👁️ ¿Ve claramente?
😊 ¿Se siente cómodo?

🔧 Ajustes gratuitos disponibles
📞 Estamos aquí para ayudarle
💚 Su satisfacción es nuestra prioridad

👁️ ¡Vea mejor, viva mejor! ✨`
            },
            proforma: {
                titulo: "📄 Factura Proforma Rural",
                mensaje: `👁️ *ÓPTICA NVISIÓN* 👁️

📄 *FACTURA PROFORMA* 📄
🌾 (Sin NCF - Zona Rural/Humanitaria)

👤 Cliente: [CLIENTE]
📱 Teléfono: [TELEFONO]
📅 Fecha: [FECHA]

🛍️ *PRODUCTOS:*
[PRODUCTOS]

💰 *TOTAL: [TOTAL]*

✅ Modalidad de pago flexible
🤝 Atención humanitaria
🌾 Servicio para zonas rurales

👁️ ¡Vea mejor, viva mejor! ✨
by fbrugaljrubinstein consultores`
            },
            emergencia: {
                titulo: "🚨 Emergencia Médica",
                mensaje: `🚨 *EMERGENCIA MÉDICA OCULAR* 🚨

📞 ÓPTICA NVISIÓN - ATENCIÓN URGENTE
👤 Paciente: [CLIENTE]
📱 Contacto: [TELEFONO]
📍 Ubicación: [UBICACION]

⚠️ *SÍNTOMAS REPORTADOS:*
[SINTOMAS]

🏥 Requiere atención médica inmediata
🚑 Derivar a emergencias si es necesario
⏰ Hora del reporte: [HORA]

📞 Tel: ${WHATSAPP_NUMBER}
🆘 RESPONDER INMEDIATAMENTE`
            }
        };

        // FUNCIONES DE UTILIDAD
        function safeGetStorage(key) {
            try {
                if (typeof(Storage) !== "undefined" && localStorage) {
                    var value = localStorage.getItem(key);
                    if (value && value !== 'null' && value !== 'undefined') {
                        return JSON.parse(value);
                    }
                }
            } catch (e) {
                console.log('Storage error:', e);
            }
            return {};
        }

        function safeSetStorage(key, value) {
            try {
                if (typeof(Storage) !== "undefined" && localStorage) {
                    localStorage.setItem(key, JSON.stringify(value));
                    return true;
                }
            } catch (e) {
                console.log('Storage error:', e);
                return false;
            }
        }

        function showAlert(message, type = 'success') {
            var alertClass = type === 'error' ? 'alert-error' : type === 'success' ? 'alert-success' : 'alert';
            var alertHtml = `<div class="alert ${alertClass}">${message}</div>`;
            document.getElementById('alertContainer').innerHTML = alertHtml;
            
            setTimeout(function() {
                document.getElementById('alertContainer').innerHTML = '';
            }, 5000);
        }

        // INICIALIZACIÓN DE FIREBASE
        function initFirebase() {
            try {
                // Solo intentar si las credenciales están configuradas
                if (firebaseConfig.apiKey === "AIzaSyC8example_key_replace_with_real") {
                    console.log('Firebase no configurado - usando modo local');
                    updateConnectionStatus(false);
                    showAlert('ℹ️ Ejecutando en modo local. Configure Firebase para sincronización.', 'error');
                    return;
                }
                
                firebaseApp = firebase.initializeApp(firebaseConfig);
                database = firebase.database();
                storage = firebase.storage();
                auth = firebase.auth();
                
                // Verificar conexión
                database.ref('.info/connected').on('value', function(snapshot) {
                    if (snapshot.val() === true) {
                        isFirebaseConnected = true;
                        updateConnectionStatus(true);
                        sincronizarConFirebase();
                    } else {
                        isFirebaseConnected = false;
                        updateConnectionStatus(false);
                    }
                });
                
            } catch (error) {
                console.error('Error inicializando Firebase:', error);
                updateConnectionStatus(false);
                showAlert('⚠️ Firebase no disponible. Usando almacenamiento local.', 'error');
            }
        }

        function updateConnectionStatus(connected) {
            const statusElement = document.getElementById('connectionStatus');
            const iconElement = document.getElementById('statusIcon');
            const textElement = document.getElementById('statusText');
            
            if (connected) {
                statusElement.className = 'connection-status status-online';
                iconElement.textContent = '🟢';
                textElement.textContent = 'Firebase Conectado';
            } else {
                statusElement.className = 'connection-status status-offline';
                iconElement.textContent = '🔴';
                textElement.textContent = 'Modo Local (Sin Firebase)';
            }
        }

        // FUNCIONES DE NAVEGACIÓN
        function goToIndex() {
            window.location.href = BASE_URL + 'index.html';
        }

        function goToAdmin() {
            var password = prompt('🔐 Contraseña de administrador:');
            if (password === 'nvision2030') {
                window.location.href = BASE_URL + 'admin.html';
            } else if (password !== null) {
                showAlert('❌ Contraseña incorrecta', 'error');
            }
        }

        function goToPOS() {
            var password = prompt('🔐 Acceso al Sistema POS:');
            if (password === 'nvision2030') {
                window.location.href = BASE_URL + 'pos.html';
            } else if (password !== null) {
                showAlert('❌ Contraseña incorrecta', 'error');
            }
        }

        // FUNCIONES DE EMERGENCIA
        function activarEmergencia() {
            if (confirm("🚨 ¿Tiene una EMERGENCIA MÉDICA en los ojos?\n\n• Dolor severo\n• Pérdida de visión\n• Accidente ocular\n• Inflamación intensa\n\n¿LLAMAR INMEDIATAMENTE?")) {
                // Intentar llamada directa
                window.open('tel:' + WHATSAPP_NUMBER.replace(/^1/, ''), '_self');
                
                // Mensaje de emergencia por WhatsApp
                setTimeout(function() {
                    enviarMensajeEmergencia();
                }, 1000);
            }
        }

        function enviarMensajeEmergencia() {
            var ubicacion = "No disponible";
            var hora = new Date().toLocaleString('es-DO');
            
            // Intentar obtener ubicación
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(position) {
                    ubicacion = `Lat: ${position.coords.latitude}, Lon: ${position.coords.longitude}`;
                    enviarWhatsAppEmergencia(ubicacion, hora);
                }, function() {
                    enviarWhatsAppEmergencia(ubicacion, hora);
                });
            } else {
                enviarWhatsAppEmergencia(ubicacion, hora);
            }
        }

        function enviarWhatsAppEmergencia(ubicacion, hora) {
            var mensaje = plantillasWhatsApp.emergencia.mensaje
                .replace('[CLIENTE]', 'Paciente urgente')
                .replace('[TELEFONO]', 'Requiere contacto inmediato')
                .replace('[UBICACION]', ubicacion)
                .replace('[SINTOMAS]', 'Por determinar - requiere evaluación')
                .replace('[HORA]', hora);
            
            var whatsappUrl = `https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(mensaje)}`;
            window.open(whatsappUrl, '_blank');
            
            showAlert('🚨 Mensaje de emergencia enviado', 'success');
        }

        // FUNCIONES DE MODAL
        function cerrarModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        function abrirModalTestVisual() {
            document.getElementById('modalTestVisual').style.display = 'block';
        }

        function abrirModalInventario() {
            document.getElementById('modalInventario').style.display = 'block';
        }

        function abrirModalTemplate() {
            document.getElementById('modalTemplate').style.display = 'block';
        }

        function abrirModalFacturacion() {
            document.getElementById('modalFacturacion').style.display = 'block';
        }

        function abrirModalVoz() {
            document.getElementById('modalVoz').style.display = 'block';
        }

        function abrirModalAyuda() {
            var mensaje = `👁️ *ÓPTICA NVISIÓN* 👁️

🤝 *SOLICITUD DE AYUDA PERSONALIZADA* 🤝

Hola, necesito asistencia desde la zona rural. 
Requiero ayuda paso a paso para:

📱 SOLICITO:
• Orientación sobre test de vista
• Ayuda para usar el sistema
• Información sobre monturas
• Asistencia personalizada

🌾 Estoy en zona rural/humanitaria
🙏 Por favor, tengan paciencia conmigo

📞 Pueden llamarme cuando sea posible
✨ ¡Gracias por su comprensión!

by fbrugaljrubinstein consultores`;
            
            var whatsappUrl = `https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(mensaje)}`;
            window.open(whatsappUrl, '_blank');
            showAlert('🤝 Solicitud de ayuda enviada', 'success');
        }

        // FUNCIONES DE TEST VISUAL
        function iniciarTestGuiado() {
            var mensaje = `👁️ *TEST DE VISTA GUIADO - ÓPTICA NVISIÓN* 👁️

🎙️ Iniciando test con instrucciones de voz paso a paso.

📋 INSTRUCCIONES:
1. Coloque el teléfono a un brazo de distancia
2. Tape un ojo con la mano
3. Lea las letras en voz alta
4. Repita con el otro ojo

🔊 Active el audio de su teléfono
👂 Escuche las instrucciones con atención

¿Está listo para comenzar el test?
Responda "SÍ" para continuar

👁️ ¡Vea mejor, viva mejor! ✨`;
            
            var whatsappUrl = `https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(mensaje)}`;
            window.open(whatsappUrl, '_blank');
            cerrarModal('modalTestVisual');
            showAlert('📱 Test visual enviado por WhatsApp', 'success');
        }

        function iniciarTestSilencioso() {
            // Redirigir al test en el sistema principal
            window.location.href = BASE_URL + 'index.html#test';
        }

        function enviarTestPorWhatsApp() {
            var mensaje = `👁️ *ENLACE AL TEST DE VISTA - ÓPTICA NVISIÓN* 👁️

🔗 Haga clic en este enlace para realizar su test de vista:
${BASE_URL}index.html

📱 INSTRUCCIONES:
• Abra el enlace en su teléfono
• Toque "Test de Vista"
• Siga las instrucciones en pantalla
• Es gratuito y rápido

👁️ Su salud visual es nuestra prioridad
✨ ¡Vea mejor, viva mejor!

by fbrugaljrubinstein consultores`;
            
            var whatsappUrl = `https://wa.me/?text=${encodeURIComponent(mensaje)}`;
            window.open(whatsappUrl, '_blank');
            cerrarModal('modalTestVisual');
            showAlert('🔗 Enlace de test enviado', 'success');
        }

        // FUNCIONES DE INVENTARIO
        function tomarFotoProducto() {
            document.getElementById('inputFotoProducto').click();
        }

        // Event listener para la cámara
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('inputFotoProducto').addEventListener('change', function(e) {
                var file = e.target.files[0];
                if (file) {
                    if (file.size > 5 * 1024 * 1024) {
                        showAlert('⚠️ La imagen es muy grande. Use una imagen menor a 5MB.', 'error');
                        return;
                    }
                    
                    var reader = new FileReader();
                    reader.onload = function(e) {
                        var preview = document.getElementById('previewProducto');
                        preview.src = e.target.result;
                        preview.style.display = 'block';
                        currentPhotoBlob = file;
                    };
                    reader.readAsDataURL(file);
                }
            });
        });

        async function guardarProductoFirebase() {
            var codigo = document.getElementById('codigoProducto').value.trim().toUpperCase();
            var descripcion = document.getElementById('descripcionProducto').value.trim();
            var precio = document.getElementById('precioProducto').value.trim();
            var stock = parseInt(document.getElementById('stockProducto').value) || 1;
            
            if (!codigo || !descripcion || !precio) {
                showAlert('⚠️ Complete todos los campos obligatorios', 'error');
                return;
            }
            
            if (!currentPhotoBlob) {
                showAlert('⚠️ Debe agregar una foto del producto', 'error');
                return;
            }
            
            try {
                var photoUrl = null;
                
                // Subir foto a Firebase Storage o convertir a base64
                if (isFirebaseConnected && storage) {
                    var storageRef = storage.ref(`productos/${codigo}_${Date.now()}.jpg`);
                    var uploadTask = await storageRef.put(currentPhotoBlob);
                    photoUrl = await uploadTask.ref.getDownloadURL();
                    showAlert('📸 Foto subida a Firebase Storage', 'success');
                } else {
                    // Fallback a base64
                    var reader = new FileReader();
                    reader.onload = function(e) {
                        photoUrl = e.target.result;
                        guardarProductoLocal(codigo, descripcion, precio, stock, photoUrl);
                    };
                    reader.readAsDataURL(currentPhotoBlob);
                    return;
                }
                
                // Guardar en Firebase Database
                if (isFirebaseConnected && database) {
                    await database.ref(`productos/${codigo}`).set({
                        codigo: codigo,
                        descripcion: descripcion,
                        precio: precio,
                        stock: stock,
                        foto: photoUrl,
                        fechaCreacion: new Date().toISOString(),
                        enlace: `${BASE_URL}index.html?codigo=${codigo}`
                    });
                    showAlert('✅ Producto guardado en Firebase', 'success');
                } else {
                    guardarProductoLocal(codigo, descripcion, precio, stock, photoUrl);
                }
                
                // Limpiar formulario
                limpiarFormularioInventario();
                
            } catch (error) {
                console.error('Error guardando producto:', error);
                showAlert('❌ Error al guardar en Firebase. Guardando localmente...', 'error');
                
                // Fallback a localStorage
                var reader = new FileReader();
                reader.onload = function(e) {
                    guardarProductoLocal(codigo, descripcion, precio, stock, e.target.result);
                };
                reader.readAsDataURL(currentPhotoBlob);
            }
        }

        function guardarProductoLocal(codigo, descripcion, precio, stock, photoUrl) {
            var monturas = safeGetStorage('nvision_monturas') || {};
            var productos = safeGetStorage('nvision_productos') || {};
            
            var producto = {
                codigo: codigo,
                nombre: descripcion,
                descripcion: descripcion,
                precio: precio,
                precioBase: parseFloat(precio.replace(/[^0-9.-]+/g,"")) || 0,
                stock: stock,
                foto: photoUrl,
                categoria: 'general',
                fechaCreacion: new Date().toISOString(),
                enlace: `${BASE_URL}index.html?codigo=${codigo}`,
                whatsapp: `https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent('Hola, me interesa la montura ' + codigo + ' "' + descripcion + '" por ' + precio + '. ¿Está disponible?')}`
            };
            
            // Guardar en ambos sistemas para compatibilidad
            monturas[codigo] = producto;
            productos[codigo] = producto;
            
            safeSetStorage('nvision_monturas', monturas);
            safeSetStorage('nvision_productos', productos);
            
            showAlert('✅ Producto guardado localmente: ' + codigo, 'success');
            limpiarFormularioInventario();
        }

        function limpiarFormularioInventario() {
            document.getElementById('codigoProducto').value = '';
            document.getElementById('descripcionProducto').value = '';
            document.getElementById('precioProducto').value = '';
            document.getElementById('stockProducto').value = '1';
            document.getElementById('previewProducto').style.display = 'none';
            document.getElementById('inputFotoProducto').value = '';
            currentPhotoBlob = null;
        }

        function enviarProductoWhatsApp() {
            var codigo = document.getElementById('codigoProducto').value.trim().toUpperCase();
            var descripcion = document.getElementById('descripcionProducto').value.trim();
            var precio = document.getElementById('precioProducto').value.trim();
            
            if (!codigo || !descripcion || !precio) {
                showAlert('⚠️ Complete los campos antes de enviar', 'error');
                return;
            }
            
            var mensaje = `👁️ *NUEVA MONTURA DISPONIBLE - ÓPTICA NVISIÓN* 👁️

📸 Nueva montura en catálogo:
🔢 Código: ${codigo}
💰 Precio: ${precio}
📝 Descripción: ${descripcion}

🔗 Ver detalles completos:
${BASE_URL}index.html?codigo=${codigo}

✨ Características:
• Garantía de calidad premium
• Ajustes gratuitos incluidos
• Entrega sin costo adicional

👁️ ¡Vea mejor, viva mejor! ✨
by fbrugaljrubinstein consultores`;
            
            var whatsappUrl = `https://wa.me/?text=${encodeURIComponent(mensaje)}`;
            window.open(whatsappUrl, '_blank');
            
            showAlert('💬 Producto compartido por WhatsApp', 'success');
        }

        // FUNCIONES DE PLANTILLAS
        function usarTemplate(tipo) {
            if (plantillasWhatsApp[tipo]) {
                var template = plantillasWhatsApp[tipo];
                var mensaje = template.mensaje;
                
                // Solicitar datos si es necesario
                if (tipo === 'promocion') {
                    var cliente = prompt('👤 Nombre del cliente:') || '[CLIENTE]';
                    var precio = prompt('💰 Precio promocional:') || '[PRECIO]';
                    var telefono = prompt('📱 Teléfono del cliente:') || '[TELEFONO]';
                    
                    mensaje = mensaje
                        .replace('[CLIENTE]', cliente)
                        .replace('[PRECIO]', precio)
                        .replace('[TELEFONO]', telefono);
                } else if (tipo === 'recordatorio') {
                    var cliente = prompt('👤 Nombre del cliente:') || '[CLIENTE]';
                    var fecha = prompt('📅 Fecha de la cita:') || '[FECHA]';
                    var hora = prompt('🕒 Hora de la cita:') || '[HORA]';
                    
                    mensaje = mensaje
                        .replace('[CLIENTE]', cliente)
                        .replace('[FECHA]', fecha)
                        .replace('[HORA]', hora);
                } else if (tipo === 'seguimiento') {
                    var cliente = prompt('👤 Nombre del cliente:') || '[CLIENTE]';
                    mensaje = mensaje.replace('[CLIENTE]', cliente);
                }
                
                var whatsappUrl = `https://wa.me/?text=${encodeURIComponent(mensaje)}`;
                window.open(whatsappUrl, '_blank');
                
                showAlert(`✅ Plantilla "${template.titulo}" enviada`, 'success');
            }
        }

        function guardarTemplate() {
            var titulo = document.getElementById('tituloTemplate').value.trim();
            var categoria = document.getElementById('categoriaTemplate').value;
            var mensaje = document.getElementById('mensajeTemplate').value.trim();
            var tipo = document.getElementById('tipoTemplate').value;
            
            if (!titulo || !mensaje) {
                showAlert('⚠️ Complete el título y mensaje', 'error');
                return;
            }
            
            var templates = safeGetStorage('nvision_templates') || {};
            var templateId = Date.now().toString();
            
            templates[templateId] = {
                id: templateId,
                titulo: titulo,
                categoria: categoria,
                mensaje: mensaje,
                tipo: tipo,
                fechaCreacion: new Date().toISOString()
            };
            
            safeSetStorage('nvision_templates', templates);
            
            showAlert('✅ Plantilla guardada exitosamente', 'success');
            cerrarModal('modalTemplate');
            cargarTemplatesPersonalizadas();
        }

        function previsualizarTemplate() {
            var mensaje = document.getElementById('mensajeTemplate').value.trim();
            if (!mensaje) {
                showAlert('⚠️ Escriba el mensaje primero', 'error');
                return;
            }
            
            alert('📱 Vista previa del mensaje:\n\n' + mensaje);
        }

        function cargarTemplatesPersonalizadas() {
            var templates = safeGetStorage('nvision_templates') || {};
            var grid = document.getElementById('templatesGrid');
            
            // Mantener templates predefinidas y agregar personalizadas
            var templateItems = grid.innerHTML;
            
            Object.keys(templates).forEach(function(key) {
                var template = templates[key];
                var preview = template.mensaje.substring(0, 60) + '...';
                
                templateItems += `
                    <div class="template-item" onclick="usarTemplatePersonalizada('${key}')">
                        <div class="template-title">${template.categoria} ${template.titulo}</div>
                        <div class="template-preview">${preview}</div>
                    </div>
                `;
            });
            
            grid.innerHTML = templateItems;
        }

        function usarTemplatePersonalizada(templateId) {
            var templates = safeGetStorage('nvision_templates') || {};
            var template = templates[templateId];
            
            if (template) {
                var whatsappUrl = `https://wa.me/?text=${encodeURIComponent(template.mensaje)}`;
                window.open(whatsappUrl, '_blank');
                showAlert(`✅ Plantilla "${template.titulo}" enviada`, 'success');
            }
        }

        // FUNCIONES DE FACTURACIÓN RÁPIDA
        function generarFacturaRapida() {
            var cliente = document.getElementById('clienteFactura').value.trim();
            var telefono = document.getElementById('telefonoFactura').value.trim();
            var tipoComprobante = document.getElementById('tipoComprobanteFactura').value;
            var total = document.getElementById('totalFactura').value.trim();
            var descripcion = document.getElementById('descripcionFactura').value.trim();
            
            if (!cliente || !telefono || !total || !descripcion) {
                showAlert('⚠️ Complete todos los campos', 'error');
                return;
            }
            
            try {
                var numeroComprobante = null;
                var esSinNCF = tipoComprobante === 'sin_ncf';
                
                if (!esSinNCF) {
                    var comprobante = new ComprobanteNCF(tipoComprobante);
                    numeroComprobante = comprobante.usar();
                }
                
                var factura = {
                    id: 'FACT-' + Date.now(),
                    numeroComprobante: numeroComprobante,
                    sinNCF: esSinNCF,
                    esProforma: esSinNCF,
                    fecha: new Date().toLocaleDateString('es-DO'),
                    cliente: {
                        nombre: cliente,
                        telefono: telefono
                    },
                    total: total,
                    descripcion: descripcion,
                    tipoComprobante: tipoComprobante
                };
                
                // Guardar factura
                var facturas = safeGetStorage('nvision_facturas') || {};
                facturas[factura.id] = factura;
                safeSetStorage('nvision_facturas', facturas);
                
                if (esSinNCF) {
                    showAlert('✅ Factura Proforma generada (Sin NCF)', 'success');
                    enviarProformaPorWhatsApp(factura);
                } else {
                    showAlert(`✅ Factura generada: ${numeroComprobante}`, 'success');
                    enviarFacturaPorWhatsApp(factura);
                }
                
                cerrarModal('modalFacturacion');
                limpiarFormularioFacturacion();
                
            } catch (error) {
                console.error('Error generando factura:', error);
                showAlert('❌ Error: ' + error.message, 'error');
            }
        }

        function enviarProformaPorWhatsApp(factura = null) {
                            if (!factura) {
                var cliente = document.getElementById('clienteFactura').value.trim();
                var telefono = document.getElementById('telefonoFactura').value.trim();
                var total = document.getElementById('totalFactura').value.trim();
                var descripcion = document.getElementById('descripcionFactura').value.trim();
                
                if (!cliente || !total) {
                    showAlert('⚠️ Complete los campos básicos', 'error');
                    return;
                }
                
                factura = {
                    cliente: { nombre: cliente, telefono: telefono },
                    total: total,
                    descripcion: descripcion,
                    fecha: new Date().toLocaleDateString('es-DO')
                };
            }
            
            var mensaje = plantillasWhatsApp.proforma.mensaje
                .replace('[CLIENTE]', factura.cliente.nombre)
                .replace('[TELEFONO]', factura.cliente.telefono)
                .replace('[FECHA]', factura.fecha)
                .replace('[PRODUCTOS]', factura.descripcion)
                .replace('[TOTAL]', factura.total);
            
            var whatsappUrl = `https://wa.me/${factura.cliente.telefono.replace(/[^0-9]/g, '')}?text=${encodeURIComponent(mensaje)}`;
            window.open(whatsappUrl, '_blank');
            
            showAlert('📄 Factura Proforma enviada por WhatsApp', 'success');
        }

        function enviarFacturaPorWhatsApp(factura) {
            var mensaje = `👁️ *FACTURA - ÓPTICA NVISIÓN* 👁️

📄 NCF: ${factura.numeroComprobante}
📅 Fecha: ${factura.fecha}
👤 Cliente: ${factura.cliente.nombre}

🛍️ Descripción: ${factura.descripcion}
💰 Total: ${factura.total}

✅ Factura fiscal válida
🤝 Gracias por su confianza

👁️ ¡Vea mejor, viva mejor! ✨
by fbrugaljrubinstein consultores`;
            
            var whatsappUrl = `https://wa.me/${factura.cliente.telefono.replace(/[^0-9]/g, '')}?text=${encodeURIComponent(mensaje)}`;
            window.open(whatsappUrl, '_blank');
        }

        function limpiarFormularioFacturacion() {
            document.getElementById('clienteFactura').value = '';
            document.getElementById('telefonoFactura').value = '';
            document.getElementById('totalFactura').value = '';
            document.getElementById('descripcionFactura').value = '';
            document.getElementById('tipoComprobanteFactura').value = 'sin_ncf';
        }

        // FUNCIONES DE AUDIO/VOZ
        function iniciarGrabacion() {
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                showAlert('❌ Su navegador no soporta grabación de audio', 'error');
                return;
            }
            
            navigator.mediaDevices.getUserMedia({ audio: true })
                .then(function(stream) {
                    mediaRecorder = new MediaRecorder(stream);
                    audioChunks = [];
                    
                    mediaRecorder.ondataavailable = function(event) {
                        audioChunks.push(event.data);
                    };
                    
                    mediaRecorder.onstop = function() {
                        audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                        var audioUrl = URL.createObjectURL(audioBlob);
                        document.getElementById('audioPlayback').src = audioUrl;
                        document.getElementById('audioPlayback').style.display = 'block';
                        document.getElementById('btnEnviar').style.display = 'block';
                        stream.getTracks().forEach(track => track.stop());
                    };
                    
                    mediaRecorder.start();
                    
                    document.getElementById('btnGrabar').style.display = 'none';
                    document.getElementById('btnDetener').style.display = 'block';
                    document.getElementById('vozStatus').textContent = 'Grabando...';
                    document.getElementById('vozIcon').textContent = '🔴';
                })
                .catch(function(error) {
                    console.error('Error accediendo al micrófono:', error);
                    showAlert('❌ No se puede acceder al micrófono', 'error');
                });
        }

        function detenerGrabacion() {
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.stop();
                document.getElementById('btnGrabar').style.display = 'block';
                document.getElementById('btnDetener').style.display = 'none';
                document.getElementById('vozStatus').textContent = 'Grabación completada';
                document.getElementById('vozIcon').textContent = '✅';
            }
        }

        function enviarNotaVoz() {
            if (!audioBlob) {
                showAlert('❌ No hay audio grabado', 'error');
                return;
            }
            
            var mensaje = `👁️ *NOTA DE VOZ - ÓPTICA NVISIÓN* 👁️

🎤 He enviado una nota de voz desde el sistema centralizado.

🌾 Desde zona rural/humanitaria
⏰ Hora: ${new Date().toLocaleString('es-DO')}

📞 Por favor escuchen el audio y respondan lo antes posible.

👁️ ¡Vea mejor, viva mejor! ✨
by fbrugaljrubinstein consultores`;
            
            var whatsappUrl = `https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(mensaje)}`;
            window.open(whatsappUrl, '_blank');
            
            showAlert('🎤 Nota de voz enviada (el audio debe enviarse manualmente)', 'success');
            cerrarModal('modalVoz');
        }

        // FUNCIONES PRINCIPALES
        function activarModoRural() {
            showAlert('🌾 Modo Rural activado - Funciones simplificadas disponibles', 'success');
            // Activar funciones específicas para zona rural
            var features = document.querySelectorAll('.feature-btn');
            features.forEach(btn => {
                btn.style.fontSize = '14px';
                btn.style.padding = '18px 12px';
            });
        }

        function compartirUbicacion() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(position) {
                    var lat = position.coords.latitude;
                    var lon = position.coords.longitude;
                    var mensaje = `👁️ *MI UBICACIÓN - ÓPTICA NVISIÓN* 👁️

📍 Mi ubicación actual:
Latitud: ${lat}
Longitud: ${lon}

🗺️ Ver en Google Maps:
https://maps.google.com/?q=${lat},${lon}

🌾 Desde zona rural/humanitaria
⏰ ${new Date().toLocaleString('es-DO')}

📞 Necesito asistencia en esta ubicación
🆘 Para emergencias o consultas

by fbrugaljrubinstein consultores`;
                    
                    var whatsappUrl = `https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(mensaje)}`;
                    window.open(whatsappUrl, '_blank');
                    
                    showAlert('📍 Ubicación compartida por WhatsApp', 'success');
                }, function() {
                    showAlert('❌ No se pudo obtener la ubicación', 'error');
                });
            } else {
                showAlert('❌ Su dispositivo no soporta geolocalización', 'error');
            }
        }

        function sincronizarTodo() {
            showAlert('🔄 Sincronizando datos...', 'success');
            
            try {
                if (isFirebaseConnected) {
                    sincronizarConFirebase();
                    showAlert('✅ Sincronización con Firebase completada', 'success');
                } else {
                    showAlert('⚠️ Sin conexión a Firebase. Datos guardados localmente.', 'error');
                }
            } catch (error) {
                console.error('Error en sincronización:', error);
                showAlert('❌ Error en sincronización', 'error');
            }
        }

        async function sincronizarConFirebase() {
            if (!isFirebaseConnected) return;
            
            try {
                // Sincronizar monturas
                var monturas = safeGetStorage('nvision_monturas');
                if (Object.keys(monturas).length > 0) {
                    await database.ref('monturas').set(monturas);
                }
                
                // Sincronizar clientes
                var clientes = safeGetStorage('nvision_clientes');
                if (Object.keys(clientes).length > 0) {
                    await database.ref('clientes').set(clientes);
                }
                
                // Sincronizar facturas
                var facturas = safeGetStorage('nvision_facturas');
                if (Object.keys(facturas).length > 0) {
                    await database.ref('facturas').set(facturas);
                }
                
                console.log('✅ Sincronización completada');
            } catch (error) {
                console.error('Error sincronizando:', error);
            }
        }

        function exportarDatos() {
            try {
                var allData = {
                    monturas: safeGetStorage('nvision_monturas'),
                    clientes: safeGetStorage('nvision_clientes'),
                    productos: safeGetStorage('nvision_productos'),
                    facturas: safeGetStorage('nvision_facturas'),
                    templates: safeGetStorage('nvision_templates'),
                    comprobantes: safeGetStorage('nvision_comprobantes'),
                    estadisticas: {
                        views: localStorage.getItem('nvision_views') || '0',
                        clicks: localStorage.getItem('nvision_whatsapp_clicks') || '0'
                    },
                    export_info: {
                        timestamp: new Date().toISOString(),
                        version: '3.0',
                        sistema: 'Nvision_Central',
                        by: 'fbrugaljrubinstein consultores'
                    }
                };

                var blob = new Blob([JSON.stringify(allData, null, 2)], {type: 'application/json'});
                var url = URL.createObjectURL(blob);
                var a = document.createElement('a');
                a.href = url;
                a.download = 'nvision_export_' + new Date().toISOString().split('T')[0] + '.json';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showAlert('✅ Datos exportados exitosamente', 'success');
            } catch (error) {
                console.error('Error exportando:', error);
                showAlert('❌ Error al exportar datos', 'error');
            }
        }

        function resetSystem() {
            if (confirm('⚠️ ¿Está seguro de resetear todo el sistema?\n\nEsto eliminará todos los datos locales.')) {
                try {
                    localStorage.clear();
                    showAlert('🔄 Sistema reseteado completamente', 'success');
                    setTimeout(() => window.location.reload(), 2000);
                } catch (error) {
                    showAlert('❌ Error al resetear', 'error');
                }
            }
        }

        // INICIALIZACIÓN
        function inicializarCentral() {
            try {
                initFirebase();
                cargarTemplatesPersonalizadas();
                
                // Verificar modo rural automático
                var userAgent = navigator.userAgent.toLowerCase();
                var isLowEnd = userAgent.includes('android 4') || userAgent.includes('opera mini');
                
                if (isLowEnd) {
                    setTimeout(() => {
                        if (confirm('🌾 ¿Activar modo rural simplificado para mejor rendimiento?')) {
                            activarModoRural();
                        }
                    }, 3000);
                }
                
                showAlert('✅ Sistema Central inicializado correctamente', 'success');
                
            } catch (error) {
                console.error('Error inicializando central:', error);
                showAlert('⚠️ Error en inicialización. Algunas funciones pueden no estar disponibles.', 'error');
            }
        }

        // Event listeners
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', inicializarCentral);
        } else {
            inicializarCentral();
        }

        // Cerrar modales al hacer clic fuera
        window.addEventListener('click', function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        });

        // Evitar zoom en móviles
        document.addEventListener('touchstart', function(event) {
            if (event.touches.length > 1) {
                event.preventDefault();
            }
        }, { passive: false });

        var lastTouchEnd = 0;
        document.addEventListener('touchend', function(event) {
            var now = (new Date()).getTime();
            if (now - lastTouchEnd <= 300) {
                event.preventDefault();
            }
            lastTouchEnd = now;
        }, false);
    </script>
</body>
</html>