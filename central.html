<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Central - Ã“ptica NvisiÃ³n</title>
    
    <!-- Firebase CDN -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            min-height: 100vh; 
            color: white; 
            padding: 15px;
        }
        .container { max-width: 500px; margin: 0 auto; }
        
        .header {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 25px;
            padding: 25px;
            text-align: center;
            margin-bottom: 25px;
        }
        
        .header h1 {
            font-size: 26px;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #fbbf24, #f59e0b);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .by-line {
            font-size: 11px;
            opacity: 0.7;
            margin-top: 10px;
            color: #e2e8f0;
        }
        
        .connection-status {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-top: 15px;
            padding: 10px;
            border-radius: 15px;
            font-size: 14px;
            font-weight: 600;
        }
        
        .status-online {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
            border: 1px solid rgba(16, 185, 129, 0.3);
        }
        
        .status-offline {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }
        
        .main-sections {
            display: grid;
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .section-card {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            padding: 20px;
        }
        
        .section-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 15px;
            text-align: center;
            color: #fbbf24;
        }
        
        .feature-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }
        
        .feature-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            padding: 15px 10px;
            border-radius: 15px;
            font-size: 13px;
            font-weight: 700;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s ease;
            touch-action: manipulation;
        }
        
        .feature-btn:hover, .feature-btn:active {
            background: rgba(255, 255, 255, 0.25);
            transform: translateY(-2px);
        }
        
        .btn-primary {
            background: linear-gradient(45deg, #22d3ee, #0891b2);
        }
        
        .btn-success {
            background: linear-gradient(45deg, #10b981, #059669);
        }
        
        .btn-warning {
            background: linear-gradient(45deg, #f59e0b, #d97706);
        }
        
        .btn-danger {
            background: linear-gradient(45deg, #ef4444, #dc2626);
        }
        
        .emergency-section {
            background: linear-gradient(45deg, #ef4444, #dc2626);
            border-radius: 25px;
            padding: 25px;
            text-align: center;
            margin-bottom: 20px;
            animation: pulse-emergency 2s infinite;
            cursor: pointer;
            touch-action: manipulation;
        }
        
        @keyframes pulse-emergency {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }
        
        .emergency-icon {
            font-size: 50px;
            margin-bottom: 15px;
        }
        
        .emergency-text {
            font-size: 20px;
            font-weight: 900;
            margin-bottom: 10px;
        }
        
        .templates-grid {
            display: grid;
            gap: 10px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .template-item {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.2);
            touch-action: manipulation;
        }
        
        .template-item:hover, .template-item:active {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .template-title {
            font-weight: 700;
            color: #60a5fa;
            margin-bottom: 5px;
            font-size: 14px;
        }
        
        .template-preview {
            font-size: 12px;
            opacity: 0.9;
            line-height: 1.3;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            overflow-y: auto;
        }
        
        .modal-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 20px auto;
            padding: 25px;
            border-radius: 25px;
            max-width: 450px;
            position: relative;
        }
        
        .modal-close {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 28px;
            cursor: pointer;
            color: white;
            touch-action: manipulation;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #e2e8f0;
            font-size: 14px;
        }
        
        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border-radius: 10px;
            font-size: 16px;
            font-family: inherit;
        }
        
        .form-input::placeholder, .form-textarea::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }
        
        .btn {
            padding: 15px 20px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin-bottom: 10px;
            touch-action: manipulation;
        }
        
        .camera-upload {
            background: rgba(255, 255, 255, 0.1);
            border: 2px dashed rgba(255, 255, 255, 0.3);
            border-radius: 15px;
            padding: 30px 15px;
            text-align: center;
            cursor: pointer;
            margin-bottom: 15px;
            transition: all 0.3s ease;
            touch-action: manipulation;
        }
        
        .camera-upload:hover, .camera-upload:active {
            background: rgba(255, 255, 255, 0.15);
            border-color: #22d3ee;
        }
        
        .camera-icon {
            font-size: 40px;
            margin-bottom: 10px;
            display: block;
        }
        
        .preview-image {
            max-width: 100%;
            width: 100%;
            height: auto;
            max-height: 300px;
            border-radius: 10px;
            margin-top: 15px;
            object-fit: cover;
        }
        
        .alert {
            background: rgba(34, 211, 238, 0.2);
            border: 1px solid rgba(34, 211, 238, 0.3);
            color: #22d3ee;
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 15px;
            text-align: center;
            font-weight: 600;
            font-size: 14px;
        }
        
        .alert-success {
            background: rgba(16, 185, 129, 0.2);
            border-color: rgba(16, 185, 129, 0.3);
            color: #10b981;
        }
        
        .alert-error {
            background: rgba(239, 68, 68, 0.2);
            border-color: rgba(239, 68, 68, 0.3);
            color: #ef4444;
        }
        
        .navigation-buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-top: 20px;
        }
        
        .nav-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 12px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s ease;
            touch-action: manipulation;
        }
        
        .nav-btn:hover, .nav-btn:active {
            background: rgba(255, 255, 255, 0.3);
        }
        
        /* EspecÃ­fico para mÃ³viles */
        @media (max-width: 480px) {
            .container { padding: 10px; }
            .header { padding: 20px; }
            .header h1 { font-size: 22px; }
            .feature-btn { padding: 12px 8px; font-size: 12px; }
            .emergency-text { font-size: 18px; }
            .form-input, .form-select, .form-textarea { font-size: 16px; }
        }
        
        /* Mejorar scroll en mÃ³viles */
        ::-webkit-scrollbar {
            width: 6px;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¯ Central Ã“ptica NvisiÃ³n</h1>
            <p>Sistema Centralizado de GestiÃ³n</p>
            <div class="by-line">by fbrugaljrubinstein consultores</div>
            
            <div id="connectionStatus" class="connection-status status-offline">
                <span id="statusIcon">ğŸ”´</span>
                <span id="statusText">Configurando Firebase...</span>
            </div>
        </div>

        <div id="alertContainer"></div>

        <!-- EMERGENCIA SIEMPRE VISIBLE -->
        <div class="emergency-section" onclick="activarEmergencia()">
            <div class="emergency-icon">ğŸš¨</div>
            <div class="emergency-text">EMERGENCIA OCULAR</div>
            <div style="font-size: 14px;">Toque para llamada inmediata</div>
        </div>

        <div class="main-sections">
            <!-- ACCESO A SISTEMAS PRINCIPALES -->
            <div class="section-card">
                <h2 class="section-title">ğŸ¥ Sistemas Principales</h2>
                <div class="feature-grid">
                    <button onclick="goToIndex()" class="feature-btn btn-primary">
                        ğŸ  Inicio<br><small>Sistema principal</small>
                    </button>
                    <button onclick="goToAdmin()" class="feature-btn btn-success">
                        âš™ï¸ AdministraciÃ³n<br><small>GestiÃ³n completa</small>
                    </button>
                    <button onclick="goToPOS()" class="feature-btn btn-warning">
                        ğŸ’¼ Punto de Venta<br><small>FacturaciÃ³n NCF</small>
                    </button>
                    <button onclick="abrirModalTestVisual()" class="feature-btn btn-danger">
                        ğŸ‘ï¸ Test Visual<br><small>Con voz guiada</small>
                    </button>
                </div>
            </div>

            <!-- WHATSAPP TEMPLATES -->
            <div class="section-card">
                <h2 class="section-title">ğŸ’¬ Plantillas WhatsApp</h2>
                <div class="templates-grid" id="templatesGrid">
                    <!-- Templates predefinidas -->
                    <div class="template-item" onclick="usarTemplate('promocion')">
                        <div class="template-title">ğŸ PromociÃ³n Especial</div>
                        <div class="template-preview">ğŸ‘ï¸ Â¡Ã“PTICA NVISIÃ“N! ğŸ PromociÃ³n especial en monturas...</div>
                    </div>
                    <div class="template-item" onclick="usarTemplate('recordatorio')">
                        <div class="template-title">â° Recordatorio Cita</div>
                        <div class="template-preview">ğŸ“… Recordatorio: Su cita estÃ¡ programada para...</div>
                    </div>
                    <div class="template-item" onclick="usarTemplate('seguimiento')">
                        <div class="template-title">ğŸ“‹ Seguimiento Post-Venta</div>
                        <div class="template-preview">ğŸ‘ï¸ Â¿CÃ³mo estÃ¡ con sus nuevos lentes?...</div>
                    </div>
                    <div class="template-item" onclick="usarTemplate('proforma')">
                        <div class="template-title">ğŸ“„ Factura Proforma Rural</div>
                        <div class="template-preview">ğŸŒ¾ Factura Proforma (Sin NCF) - Zona Rural/Humanitaria...</div>
                    </div>
                </div>
                <button onclick="abrirModalTemplate()" class="feature-btn btn-primary" style="margin-top: 15px;">
                    â• Nueva Plantilla
                </button>
            </div>

            <!-- MODO RURAL/HUMANITARIO -->
            <div class="section-card">
                <h2 class="section-title">ğŸŒ¾ Modo Rural/Humanitario</h2>
                <div class="feature-grid">
                    <button onclick="activarModoRural()" class="feature-btn btn-success">
                        ğŸŒ¾ Activar Modo<br><small>Para zonas rurales</small>
                    </button>
                    <button onclick="abrirModalAyuda()" class="feature-btn btn-warning">
                        ğŸ¤ Solicitar Ayuda<br><small>Asistencia remota</small>
                    </button>
                    <button onclick="abrirModalVoz()" class="feature-btn btn-primary">
                        ğŸ¤ Nota de Voz<br><small>Enviar audio</small>
                    </button>
                    <button onclick="compartirUbicacion()" class="feature-btn btn-danger">
                        ğŸ“ Mi UbicaciÃ³n<br><small>Para emergencias</small>
                    </button>
                </div>
            </div>

            <!-- GESTIÃ“N RÃPIDA -->
            <div class="section-card">
                <h2 class="section-title">âš¡ Acciones RÃ¡pidas</h2>
                <div class="feature-grid">
                    <button onclick="abrirModalInventario()" class="feature-btn btn-primary">
                        ğŸ“¦ Agregar Producto<br><small>Con foto</small>
                    </button>
                    <button onclick="abrirModalFacturacion()" class="feature-btn btn-success">
                        ğŸ’° Factura RÃ¡pida<br><small>NCF automÃ¡tico</small>
                    </button>
                    <button onclick="sincronizarTodo()" class="feature-btn btn-warning">
                        ğŸ”„ Sincronizar<br><small>Firebase + Local</small>
                    </button>
                    <button onclick="exportarDatos()" class="feature-btn btn-danger">
                        ğŸ“¤ Exportar<br><small>Backup completo</small>
                    </button>
                </div>
            </div>
        </div>

        <!-- NAVEGACIÃ“N A OTROS MÃ“DULOS -->
        <div class="navigation-buttons">
            <button onclick="goToIndex()" class="nav-btn">ğŸ  Inicio</button>
            <button onclick="goToAdmin()" class="nav-btn">âš™ï¸ Admin</button>
            <button onclick="goToPOS()" class="nav-btn">ğŸ’¼ POS</button>
            <button onclick="resetSystem()" class="nav-btn">ğŸ”„ Reset</button>
        </div>
    </div>

    <!-- MODAL TEST VISUAL -->
    <div id="modalTestVisual" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="cerrarModal('modalTestVisual')">&times;</span>
            <h2 class="section-title">ğŸ‘ï¸ Test Visual Guiado</h2>
            
            <div id="testStepContainer">
                <div style="text-align: center; padding: 30px;">
                    <div style="font-size: 60px; margin-bottom: 20px;">ğŸ‘ï¸</div>
                    <div style="font-size: 18px; margin-bottom: 20px;">Test de vista con instrucciones de voz</div>
                    <button onclick="iniciarTestGuiado()" class="btn btn-primary">ğŸ™ï¸ Iniciar Test con Voz</button>
                    <button onclick="iniciarTestSilencioso()" class="btn btn-success">ğŸ‘€ Test Silencioso</button>
                    <button onclick="enviarTestPorWhatsApp()" class="btn btn-warning">ğŸ’¬ Enviar Test por WhatsApp</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL INVENTARIO -->
    <div id="modalInventario" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="cerrarModal('modalInventario')">&times;</span>
            <h2 class="section-title">ğŸ“¦ Nuevo Producto</h2>
            
            <div class="form-group">
                <label class="form-label">ğŸ“¸ Foto del Producto</label>
                <div class="camera-upload" onclick="tomarFotoProducto()">
                    <span class="camera-icon">ğŸ“·</span>
                    <div>Tomar foto con cÃ¡mara</div>
                    <img id="previewProducto" class="preview-image" style="display: none;">
                </div>
                <input type="file" id="inputFotoProducto" accept="image/*" capture="environment" style="display: none;">
            </div>
            
            <div class="form-group">
                <label class="form-label">ğŸ”¤ CÃ³digo del Producto</label>
                <input type="text" id="codigoProducto" class="form-input" placeholder="NV001, NV002..." style="text-transform: uppercase;">
            </div>
            
            <div class="form-group">
                <label class="form-label">ğŸ“ DescripciÃ³n</label>
                <textarea id="descripcionProducto" class="form-textarea" rows="3" placeholder="Montura elegante para dama..."></textarea>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <div class="form-group">
                    <label class="form-label">ğŸ’° Precio</label>
                    <input type="text" id="precioProducto" class="form-input" placeholder="RD$2,500">
                </div>
                <div class="form-group">
                    <label class="form-label">ğŸ“Š Stock</label>
                    <input type="number" id="stockProducto" class="form-input" placeholder="1" min="0">
                </div>
            </div>
            
            <button onclick="guardarProductoFirebase()" class="btn btn-primary">â˜ï¸ Guardar en Firebase</button>
            <button onclick="enviarProductoWhatsApp()" class="btn btn-success">ğŸ’¬ Enviar por WhatsApp</button>
        </div>
    </div>

    <!-- MODAL PLANTILLA WHATSAPP -->
    <div id="modalTemplate" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="cerrarModal('modalTemplate')">&times;</span>
            <h2 class="section-title">ğŸ’¬ Nueva Plantilla WhatsApp</h2>
            
            <div class="form-group">
                <label class="form-label">ğŸ“ TÃ­tulo de la Plantilla</label>
                <input type="text" id="tituloTemplate" class="form-input" placeholder="Ej: PromociÃ³n Lentes">
            </div>
            
            <div class="form-group">
                <label class="form-label">ğŸ“‚ CategorÃ­a</label>
                <select id="categoriaTemplate" class="form-select">
                    <option value="promocion">ğŸ PromociÃ³n</option>
                    <option value="informativo">â„¹ï¸ Informativo</option>
                    <option value="recordatorio">â° Recordatorio</option>
                    <option value="emergencia">ğŸš¨ Emergencia</option>
                    <option value="seguimiento">ğŸ“‹ Seguimiento</option>
                    <option value="proforma">ğŸŒ¾ Factura Proforma Rural</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">ğŸ’¬ Mensaje (con iconos)</label>
                <textarea id="mensajeTemplate" class="form-textarea" rows="6" placeholder="ğŸ‘ï¸ Â¡Ã“PTICA NVISIÃ“N! ğŸ‘ï¸

ğŸ PromociÃ³n especial...
ğŸ’° Precio: [PRECIO]
ğŸ“± Cliente: [CLIENTE]

âœ¨ Â¡Vea mejor, viva mejor!"></textarea>
            </div>
            
            <div class="form-group">
                <label class="form-label">ğŸ¯ Tipo de Uso</label>
                <select id="tipoTemplate" class="form-select">
                    <option value="individual">ğŸ‘¤ Individual</option>
                    <option value="masivo">ğŸ“¢ Masivo</option>
                    <option value="automatico">ğŸ¤– AutomÃ¡tico</option>
                </select>
            </div>
            
            <button onclick="guardarTemplate()" class="btn btn-primary">ğŸ’¾ Guardar Plantilla</button>
            <button onclick="previsualizarTemplate()" class="btn btn-success">ğŸ‘€ Previsualizar</button>
        </div>
    </div>

    <!-- MODAL FACTURACIÃ“N RÃPIDA -->
    <div id="modalFacturacion" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="cerrarModal('modalFacturacion')">&times;</span>
            <h2 class="section-title">ğŸ’° FacturaciÃ³n RÃ¡pida</h2>
            
            <div class="form-group">
                <label class="form-label">ğŸ‘¤ Cliente</label>
                <input type="text" id="clienteFactura" class="form-input" placeholder="Nombre del cliente">
            </div>
            
            <div class="form-group">
                <label class="form-label">ğŸ“± TelÃ©fono</label>
                <input type="tel" id="telefonoFactura" class="form-input" placeholder="849-000-0000">
            </div>
            
            <div class="form-group">
                <label class="form-label">ğŸ“‹ Tipo de Comprobante</label>
                <select id="tipoComprobanteFactura" class="form-select">
                    <option value="sin_ncf">ğŸŒ¾ Sin NCF (Zona Rural/Humanitario)</option>
                    <option value="consumidor">ğŸ§¾ Consumidor Final</option>
                    <option value="empresarial">ğŸ¢ Empresarial</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">ğŸ’° Total</label>
                <input type="text" id="totalFactura" class="form-input" placeholder="RD$0.00">
            </div>
            
            <div class="form-group">
                <label class="form-label">ğŸ“ DescripciÃ³n</label>
                <textarea id="descripcionFactura" class="form-textarea" rows="3" placeholder="Montura + lentes graduados..."></textarea>
            </div>
            
            <button onclick="generarFacturaRapida()" class="btn btn-primary">ğŸ“„ Generar Factura</button>
            <button onclick="enviarProformaPorWhatsApp()" class="btn btn-success">ğŸ’¬ Enviar Proforma</button>
        </div>
    </div>

    <!-- MODAL NOTA DE VOZ -->
    <div id="modalVoz" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="cerrarModal('modalVoz')">&times;</span>
            <h2 class="section-title">ğŸ¤ Enviar Nota de Voz</h2>
            
            <div style="text-align: center; padding: 30px;">
                <div id="vozStatus" style="font-size: 18px; margin-bottom: 20px;">Listo para grabar</div>
                <div style="font-size: 80px; margin-bottom: 30px;" id="vozIcon">ğŸ¤</div>
                
                <button id="btnGrabar" onclick="iniciarGrabacion()" class="btn btn-danger">ğŸ”´ Iniciar GrabaciÃ³n</button>
                <button id="btnDetener" onclick="detenerGrabacion()" class="btn btn-warning" style="display: none;">â¹ï¸ Detener</button>
                <button id="btnEnviar" onclick="enviarNotaVoz()" class="btn btn-success" style="display: none;">ğŸ“¤ Enviar por WhatsApp</button>
                
                <div style="margin-top: 20px;">
                    <audio id="audioPlayback" controls style="display: none; width: 100%;"></audio>
                </div>
            </div>
        </div>
    </div>

    <script>
        // CONFIGURACIÃ“N FIREBASE - REEMPLAZAR CON DATOS REALES
        const firebaseConfig = {
            // ConfiguraciÃ³n de ejemplo - debe reemplazarse
            apiKey: "AIzaSyC8example_key_replace_with_real",
            authDomain: "nvision-optica.firebaseapp.com",
            databaseURL: "https://nvision-optica-default-rtdb.firebaseio.com",
            projectId: "nvision-optica",
            storageBucket: "nvision-optica.appspot.com",
            messagingSenderId: "123456789",
            appId: "1:123456789:web:abcdef123456"
        };

        // VARIABLES GLOBALES
        var WHATSAPP_NUMBER = '18497972424';
        var BASE_URL = window.location.origin + window.location.pathname.replace(/[^/]*$/, '');
        var firebaseApp, database, storage, auth;
        var isFirebaseConnected = false;
        var currentPhotoBlob = null;
        var mediaRecorder = null;
        var audioChunks = [];
        var audioBlob = null;

        // CLASE PARA MANEJO DE COMPROBANTES NCF MEJORADA
        class ComprobanteNCF {
            constructor(tipo, inicial = 1, final = 99999) {
                this.tipo = tipo;
                this.actual = inicial;
                this.final = final;
                this.prefijo = this.getPrefijo(tipo);
            }
            
            getPrefijo(tipo) {
                const prefijos = {
                    'consumidor': 'B01',
                    'empresarial': 'B02',
                    'gubernamental': 'B03',
                    'zona_franca': 'B04'
                };
                return prefijos[tipo] || 'B01';
            }
            
            usar() {
                if (this.actual > this.final) {
                    throw new Error(`âŒ No quedan comprobantes ${this.tipo}. Rango agotado.`);
                }
                const numero = this.prefijo + String(this.actual).padStart(11, '0');
                this.actual++;
                this.guardarEnFirebase();
                return numero;
            }
            
            obtenerSiguiente() {
                if (this.actual > this.final) {
                    return null;
                }
                return this.prefijo + String(this.actual).padStart(11, '0');
            }
            
            quedan() {
                return Math.max(0, this.final - this.actual + 1);
            }
            
            async guardarEnFirebase() {
                if (isFirebaseConnected && database) {
                    try {
                        await database.ref(`comprobantes/${this.tipo}`).set({
                            actual: this.actual,
                            final: this.final,
                            prefijo: this.prefijo,
                            ultimaActualizacion: new Date().toISOString()
                        });
                    } catch (error) {
                        console.error('Error guardando comprobante en Firebase:', error);
                        // Fallback a localStorage
                        this.guardarLocal();
                    }
                } else {
                    this.guardarLocal();
                }
            }
            
            guardarLocal() {
                try {
                    var comprobantes = safeGetStorage('nvision_comprobantes') || {};
                    comprobantes[this.tipo] = {
                        actual: this.actual,
                        final: this.final,
                        prefijo: this.prefijo
                    };
                    safeSetStorage('nvision_comprobantes', comprobantes);
                } catch (error) {
                    console.error('Error guardando comprobante local:', error);
                }
            }
        }

        // PLANTILLAS WHATSAPP PREDEFINIDAS
        const plantillasWhatsApp = {
            promocion: {
                titulo: "ğŸ PromociÃ³n Especial",
                mensaje: `ğŸ‘ï¸ *Ã“PTICA NVISIÃ“N* ğŸ‘ï¸

ğŸ *PROMOCIÃ“N ESPECIAL* ğŸ
ğŸ’° Precio especial: [PRECIO]
ğŸ‘¤ Para: [CLIENTE]
ğŸ“± Tel: [TELEFONO]

ğŸ”¥ Oferta limitada en monturas premium
âœ¨ GarantÃ­a de calidad
ğŸšš Entrega gratuita

ğŸ‘ï¸ Â¡Vea mejor, viva mejor! âœ¨
by fbrugaljrubinstein consultores`
            },
            recordatorio: {
                titulo: "â° Recordatorio Cita",
                mensaje: `ğŸ‘ï¸ *Ã“PTICA NVISIÃ“N* ğŸ‘ï¸

â° *RECORDATORIO DE CITA* â°
ğŸ‘¤ [CLIENTE]
ğŸ“… Fecha: [FECHA]
ğŸ•’ Hora: [HORA]

ğŸ“ Recuerde traer:
â€¢ CÃ©dula de identidad
â€¢ Seguro mÃ©dico (si aplica)
â€¢ Lentes actuales

ğŸ“± Para cambios: ${WHATSAPP_NUMBER}
ğŸ‘ï¸ Â¡Vea mejor, viva mejor! âœ¨`
            },
            seguimiento: {
                titulo: "ğŸ“‹ Seguimiento Post-Venta",
                mensaje: `ğŸ‘ï¸ *Ã“PTICA NVISIÃ“N* ğŸ‘ï¸

ğŸ“‹ *SEGUIMIENTO POST-VENTA* ğŸ“‹
ğŸ‘¤ [CLIENTE]

â“ Â¿CÃ³mo estÃ¡ con sus nuevos lentes?
ğŸ‘ï¸ Â¿Ve claramente?
ğŸ˜Š Â¿Se siente cÃ³modo?

ğŸ”§ Ajustes gratuitos disponibles
ğŸ“ Estamos aquÃ­ para ayudarle
ğŸ’š Su satisfacciÃ³n es nuestra prioridad

ğŸ‘ï¸ Â¡Vea mejor, viva mejor! âœ¨`
            },
            proforma: {
                titulo: "ğŸ“„ Factura Proforma Rural",
                mensaje: `ğŸ‘ï¸ *Ã“PTICA NVISIÃ“N* ğŸ‘ï¸

ğŸ“„ *FACTURA PROFORMA* ğŸ“„
ğŸŒ¾ (Sin NCF - Zona Rural/Humanitaria)

ğŸ‘¤ Cliente: [CLIENTE]
ğŸ“± TelÃ©fono: [TELEFONO]
ğŸ“… Fecha: [FECHA]

ğŸ›ï¸ *PRODUCTOS:*
[PRODUCTOS]

ğŸ’° *TOTAL: [TOTAL]*

âœ… Modalidad de pago flexible
ğŸ¤ AtenciÃ³n humanitaria
ğŸŒ¾ Servicio para zonas rurales

ğŸ‘ï¸ Â¡Vea mejor, viva mejor! âœ¨
by fbrugaljrubinstein consultores`
            },
            emergencia: {
                titulo: "ğŸš¨ Emergencia MÃ©dica",
                mensaje: `ğŸš¨ *EMERGENCIA MÃ‰DICA OCULAR* ğŸš¨

ğŸ“ Ã“PTICA NVISIÃ“N - ATENCIÃ“N URGENTE
ğŸ‘¤ Paciente: [CLIENTE]
ğŸ“± Contacto: [TELEFONO]
ğŸ“ UbicaciÃ³n: [UBICACION]

âš ï¸ *SÃNTOMAS REPORTADOS:*
[SINTOMAS]

ğŸ¥ Requiere atenciÃ³n mÃ©dica inmediata
ğŸš‘ Derivar a emergencias si es necesario
â° Hora del reporte: [HORA]

ğŸ“ Tel: ${WHATSAPP_NUMBER}
ğŸ†˜ RESPONDER INMEDIATAMENTE`
            }
        };

        // FUNCIONES DE UTILIDAD
        function safeGetStorage(key) {
            try {
                if (typeof(Storage) !== "undefined" && localStorage) {
                    var value = localStorage.getItem(key);
                    if (value && value !== 'null' && value !== 'undefined') {
                        return JSON.parse(value);
                    }
                }
            } catch (e) {
                console.log('Storage error:', e);
            }
            return {};
        }

        function safeSetStorage(key, value) {
            try {
                if (typeof(Storage) !== "undefined" && localStorage) {
                    localStorage.setItem(key, JSON.stringify(value));
                    return true;
                }
            } catch (e) {
                console.log('Storage error:', e);
                return false;
            }
        }

        function showAlert(message, type = 'success') {
            var alertClass = type === 'error' ? 'alert-error' : type === 'success' ? 'alert-success' : 'alert';
            var alertHtml = `<div class="alert ${alertClass}">${message}</div>`;
            document.getElementById('alertContainer').innerHTML = alertHtml;
            
            setTimeout(function() {
                document.getElementById('alertContainer').innerHTML = '';
            }, 5000);
        }

        // INICIALIZACIÃ“N DE FIREBASE
        function initFirebase() {
            try {
                // Solo intentar si las credenciales estÃ¡n configuradas
                if (firebaseConfig.apiKey === "AIzaSyC8example_key_replace_with_real") {
                    console.log('Firebase no configurado - usando modo local');
                    updateConnectionStatus(false);
                    showAlert('â„¹ï¸ Ejecutando en modo local. Configure Firebase para sincronizaciÃ³n.', 'error');
                    return;
                }
                
                firebaseApp = firebase.initializeApp(firebaseConfig);
                database = firebase.database();
                storage = firebase.storage();
                auth = firebase.auth();
                
                // Verificar conexiÃ³n
                database.ref('.info/connected').on('value', function(snapshot) {
                    if (snapshot.val() === true) {
                        isFirebaseConnected = true;
                        updateConnectionStatus(true);
                        sincronizarConFirebase();
                    } else {
                        isFirebaseConnected = false;
                        updateConnectionStatus(false);
                    }
                });
                
            } catch (error) {
                console.error('Error inicializando Firebase:', error);
                updateConnectionStatus(false);
                showAlert('âš ï¸ Firebase no disponible. Usando almacenamiento local.', 'error');
            }
        }

        function updateConnectionStatus(connected) {
            const statusElement = document.getElementById('connectionStatus');
            const iconElement = document.getElementById('statusIcon');
            const textElement = document.getElementById('statusText');
            
            if (connected) {
                statusElement.className = 'connection-status status-online';
                iconElement.textContent = 'ğŸŸ¢';
                textElement.textContent = 'Firebase Conectado';
            } else {
                statusElement.className = 'connection-status status-offline';
                iconElement.textContent = 'ğŸ”´';
                textElement.textContent = 'Modo Local (Sin Firebase)';
            }
        }

        // FUNCIONES DE NAVEGACIÃ“N
        function goToIndex() {
            window.location.href = BASE_URL + 'index.html';
        }

        function goToAdmin() {
            var password = prompt('ğŸ” ContraseÃ±a de administrador:');
            if (password === 'nvision2030') {
                window.location.href = BASE_URL + 'admin.html';
            } else if (password !== null) {
                showAlert('âŒ ContraseÃ±a incorrecta', 'error');
            }
        }

        function goToPOS() {
            var password = prompt('ğŸ” Acceso al Sistema POS:');
            if (password === 'nvision2030') {
                window.location.href = BASE_URL + 'pos.html';
            } else if (password !== null) {
                showAlert('âŒ ContraseÃ±a incorrecta', 'error');
            }
        }

        // FUNCIONES DE EMERGENCIA
        function activarEmergencia() {
            if (confirm("ğŸš¨ Â¿Tiene una EMERGENCIA MÃ‰DICA en los ojos?\n\nâ€¢ Dolor severo\nâ€¢ PÃ©rdida de visiÃ³n\nâ€¢ Accidente ocular\nâ€¢ InflamaciÃ³n intensa\n\nÂ¿LLAMAR INMEDIATAMENTE?")) {
                // Intentar llamada directa
                window.open('tel:' + WHATSAPP_NUMBER.replace(/^1/, ''), '_self');
                
                // Mensaje de emergencia por WhatsApp
                setTimeout(function() {
                    enviarMensajeEmergencia();
                }, 1000);
            }
        }

        function enviarMensajeEmergencia() {
            var ubicacion = "No disponible";
            var hora = new Date().toLocaleString('es-DO');
            
            // Intentar obtener ubicaciÃ³n
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(position) {
                    ubicacion = `Lat: ${position.coords.latitude}, Lon: ${position.coords.longitude}`;
                    enviarWhatsAppEmergencia(ubicacion, hora);
                }, function() {
                    enviarWhatsAppEmergencia(ubicacion, hora);
                });
            } else {
                enviarWhatsAppEmergencia(ubicacion, hora);
            }
        }

        function enviarWhatsAppEmergencia(ubicacion, hora) {
            var mensaje = plantillasWhatsApp.emergencia.mensaje
                .replace('[CLIENTE]', 'Paciente urgente')
                .replace('[TELEFONO]', 'Requiere contacto inmediato')
                .replace('[UBICACION]', ubicacion)
                .replace('[SINTOMAS]', 'Por determinar - requiere evaluaciÃ³n')
                .replace('[HORA]', hora);
            
            var whatsappUrl = `https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(mensaje)}`;
            window.open(whatsappUrl, '_blank');
            
            showAlert('ğŸš¨ Mensaje de emergencia enviado', 'success');
        }

        // FUNCIONES DE MODAL
        function cerrarModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        function abrirModalTestVisual() {
            document.getElementById('modalTestVisual').style.display = 'block';
        }

        function abrirModalInventario() {
            document.getElementById('modalInventario').style.display = 'block';
        }

        function abrirModalTemplate() {
            document.getElementById('modalTemplate').style.display = 'block';
        }

        function abrirModalFacturacion() {
            document.getElementById('modalFacturacion').style.display = 'block';
        }

        function abrirModalVoz() {
            document.getElementById('modalVoz').style.display = 'block';
        }

        function abrirModalAyuda() {
            var mensaje = `ğŸ‘ï¸ *Ã“PTICA NVISIÃ“N* ğŸ‘ï¸

ğŸ¤ *SOLICITUD DE AYUDA PERSONALIZADA* ğŸ¤

Hola, necesito asistencia desde la zona rural. 
Requiero ayuda paso a paso para:

ğŸ“± SOLICITO:
â€¢ OrientaciÃ³n sobre test de vista
â€¢ Ayuda para usar el sistema
â€¢ InformaciÃ³n sobre monturas
â€¢ Asistencia personalizada

ğŸŒ¾ Estoy en zona rural/humanitaria
ğŸ™ Por favor, tengan paciencia conmigo

ğŸ“ Pueden llamarme cuando sea posible
âœ¨ Â¡Gracias por su comprensiÃ³n!

by fbrugaljrubinstein consultores`;
            
            var whatsappUrl = `https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(mensaje)}`;
            window.open(whatsappUrl, '_blank');
            showAlert('ğŸ¤ Solicitud de ayuda enviada', 'success');
        }

        // FUNCIONES DE TEST VISUAL
        function iniciarTestGuiado() {
            var mensaje = `ğŸ‘ï¸ *TEST DE VISTA GUIADO - Ã“PTICA NVISIÃ“N* ğŸ‘ï¸

ğŸ™ï¸ Iniciando test con instrucciones de voz paso a paso.

ğŸ“‹ INSTRUCCIONES:
1. Coloque el telÃ©fono a un brazo de distancia
2. Tape un ojo con la mano
3. Lea las letras en voz alta
4. Repita con el otro ojo

ğŸ”Š Active el audio de su telÃ©fono
ğŸ‘‚ Escuche las instrucciones con atenciÃ³n

Â¿EstÃ¡ listo para comenzar el test?
Responda "SÃ" para continuar

ğŸ‘ï¸ Â¡Vea mejor, viva mejor! âœ¨`;
            
            var whatsappUrl = `https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(mensaje)}`;
            window.open(whatsappUrl, '_blank');
            cerrarModal('modalTestVisual');
            showAlert('ğŸ“± Test visual enviado por WhatsApp', 'success');
        }

        function iniciarTestSilencioso() {
            // Redirigir al test en el sistema principal
            window.location.href = BASE_URL + 'index.html#test';
        }

        function enviarTestPorWhatsApp() {
            var mensaje = `ğŸ‘ï¸ *ENLACE AL TEST DE VISTA - Ã“PTICA NVISIÃ“N* ğŸ‘ï¸

ğŸ”— Haga clic en este enlace para realizar su test de vista:
${BASE_URL}index.html

ğŸ“± INSTRUCCIONES:
â€¢ Abra el enlace en su telÃ©fono
â€¢ Toque "Test de Vista"
â€¢ Siga las instrucciones en pantalla
â€¢ Es gratuito y rÃ¡pido

ğŸ‘ï¸ Su salud visual es nuestra prioridad
âœ¨ Â¡Vea mejor, viva mejor!

by fbrugaljrubinstein consultores`;
            
            var whatsappUrl = `https://wa.me/?text=${encodeURIComponent(mensaje)}`;
            window.open(whatsappUrl, '_blank');
            cerrarModal('modalTestVisual');
            showAlert('ğŸ”— Enlace de test enviado', 'success');
        }

        // FUNCIONES DE INVENTARIO
        function tomarFotoProducto() {
            document.getElementById('inputFotoProducto').click();
        }

        // Event listener para la cÃ¡mara
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('inputFotoProducto').addEventListener('change', function(e) {
                var file = e.target.files[0];
                if (file) {
                    if (file.size > 5 * 1024 * 1024) {
                        showAlert('âš ï¸ La imagen es muy grande. Use una imagen menor a 5MB.', 'error');
                        return;
                    }
                    
                    var reader = new FileReader();
                    reader.onload = function(e) {
                        var preview = document.getElementById('previewProducto');
                        preview.src = e.target.result;
                        preview.style.display = 'block';
                        currentPhotoBlob = file;
                    };
                    reader.readAsDataURL(file);
                }
            });
        });

        async function guardarProductoFirebase() {
            var codigo = document.getElementById('codigoProducto').value.trim().toUpperCase();
            var descripcion = document.getElementById('descripcionProducto').value.trim();
            var precio = document.getElementById('precioProducto').value.trim();
            var stock = parseInt(document.getElementById('stockProducto').value) || 1;
            
            if (!codigo || !descripcion || !precio) {
                showAlert('âš ï¸ Complete todos los campos obligatorios', 'error');
                return;
            }
            
            if (!currentPhotoBlob) {
                showAlert('âš ï¸ Debe agregar una foto del producto', 'error');
                return;
            }
            
            try {
                var photoUrl = null;
                
                // Subir foto a Firebase Storage o convertir a base64
                if (isFirebaseConnected && storage) {
                    var storageRef = storage.ref(`productos/${codigo}_${Date.now()}.jpg`);
                    var uploadTask = await storageRef.put(currentPhotoBlob);
                    photoUrl = await uploadTask.ref.getDownloadURL();
                    showAlert('ğŸ“¸ Foto subida a Firebase Storage', 'success');
                } else {
                    // Fallback a base64
                    var reader = new FileReader();
                    reader.onload = function(e) {
                        photoUrl = e.target.result;
                        guardarProductoLocal(codigo, descripcion, precio, stock, photoUrl);
                    };
                    reader.readAsDataURL(currentPhotoBlob);
                    return;
                }
                
                // Guardar en Firebase Database
                if (isFirebaseConnected && database) {
                    await database.ref(`productos/${codigo}`).set({
                        codigo: codigo,
                        descripcion: descripcion,
                        precio: precio,
                        stock: stock,
                        foto: photoUrl,
                        fechaCreacion: new Date().toISOString(),
                        enlace: `${BASE_URL}index.html?codigo=${codigo}`
                    });
                    showAlert('âœ… Producto guardado en Firebase', 'success');
                } else {
                    guardarProductoLocal(codigo, descripcion, precio, stock, photoUrl);
                }
                
                // Limpiar formulario
                limpiarFormularioInventario();
                
            } catch (error) {
                console.error('Error guardando producto:', error);
                showAlert('âŒ Error al guardar en Firebase. Guardando localmente...', 'error');
                
                // Fallback a localStorage
                var reader = new FileReader();
                reader.onload = function(e) {
                    guardarProductoLocal(codigo, descripcion, precio, stock, e.target.result);
                };
                reader.readAsDataURL(currentPhotoBlob);
            }
        }

        function guardarProductoLocal(codigo, descripcion, precio, stock, photoUrl) {
            var monturas = safeGetStorage('nvision_monturas') || {};
            var productos = safeGetStorage('nvision_productos') || {};
            
            var producto = {
                codigo: codigo,
                nombre: descripcion,
                descripcion: descripcion,
                precio: precio,
                precioBase: parseFloat(precio.replace(/[^0-9.-]+/g,"")) || 0,
                stock: stock,
                foto: photoUrl,
                categoria: 'general',
                fechaCreacion: new Date().toISOString(),
                enlace: `${BASE_URL}index.html?codigo=${codigo}`,
                whatsapp: `https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent('Hola, me interesa la montura ' + codigo + ' "' + descripcion + '" por ' + precio + '. Â¿EstÃ¡ disponible?')}`
            };
            
            // Guardar en ambos sistemas para compatibilidad
            monturas[codigo] = producto;
            productos[codigo] = producto;
            
            safeSetStorage('nvision_monturas', monturas);
            safeSetStorage('nvision_productos', productos);
            
            showAlert('âœ… Producto guardado localmente: ' + codigo, 'success');
            limpiarFormularioInventario();
        }

        function limpiarFormularioInventario() {
            document.getElementById('codigoProducto').value = '';
            document.getElementById('descripcionProducto').value = '';
            document.getElementById('precioProducto').value = '';
            document.getElementById('stockProducto').value = '1';
            document.getElementById('previewProducto').style.display = 'none';
            document.getElementById('inputFotoProducto').value = '';
            currentPhotoBlob = null;
        }

        function enviarProductoWhatsApp() {
            var codigo = document.getElementById('codigoProducto').value.trim().toUpperCase();
            var descripcion = document.getElementById('descripcionProducto').value.trim();
            var precio = document.getElementById('precioProducto').value.trim();
            
            if (!codigo || !descripcion || !precio) {
                showAlert('âš ï¸ Complete los campos antes de enviar', 'error');
                return;
            }
            
            var mensaje = `ğŸ‘ï¸ *NUEVA MONTURA DISPONIBLE - Ã“PTICA NVISIÃ“N* ğŸ‘ï¸

ğŸ“¸ Nueva montura en catÃ¡logo:
ğŸ”¢ CÃ³digo: ${codigo}
ğŸ’° Precio: ${precio}
ğŸ“ DescripciÃ³n: ${descripcion}

ğŸ”— Ver detalles completos:
${BASE_URL}index.html?codigo=${codigo}

âœ¨ CaracterÃ­sticas:
â€¢ GarantÃ­a de calidad premium
â€¢ Ajustes gratuitos incluidos
â€¢ Entrega sin costo adicional

ğŸ‘ï¸ Â¡Vea mejor, viva mejor! âœ¨
by fbrugaljrubinstein consultores`;
            
            var whatsappUrl = `https://wa.me/?text=${encodeURIComponent(mensaje)}`;
            window.open(whatsappUrl, '_blank');
            
            showAlert('ğŸ’¬ Producto compartido por WhatsApp', 'success');
        }

        // FUNCIONES DE PLANTILLAS
        function usarTemplate(tipo) {
            if (plantillasWhatsApp[tipo]) {
                var template = plantillasWhatsApp[tipo];
                var mensaje = template.mensaje;
                
                // Solicitar datos si es necesario
                if (tipo === 'promocion') {
                    var cliente = prompt('ğŸ‘¤ Nombre del cliente:') || '[CLIENTE]';
                    var precio = prompt('ğŸ’° Precio promocional:') || '[PRECIO]';
                    var telefono = prompt('ğŸ“± TelÃ©fono del cliente:') || '[TELEFONO]';
                    
                    mensaje = mensaje
                        .replace('[CLIENTE]', cliente)
                        .replace('[PRECIO]', precio)
                        .replace('[TELEFONO]', telefono);
                } else if (tipo === 'recordatorio') {
                    var cliente = prompt('ğŸ‘¤ Nombre del cliente:') || '[CLIENTE]';
                    var fecha = prompt('ğŸ“… Fecha de la cita:') || '[FECHA]';
                    var hora = prompt('ğŸ•’ Hora de la cita:') || '[HORA]';
                    
                    mensaje = mensaje
                        .replace('[CLIENTE]', cliente)
                        .replace('[FECHA]', fecha)
                        .replace('[HORA]', hora);
                } else if (tipo === 'seguimiento') {
                    var cliente = prompt('ğŸ‘¤ Nombre del cliente:') || '[CLIENTE]';
                    mensaje = mensaje.replace('[CLIENTE]', cliente);
                }
                
                var whatsappUrl = `https://wa.me/?text=${encodeURIComponent(mensaje)}`;
                window.open(whatsappUrl, '_blank');
                
                showAlert(`âœ… Plantilla "${template.titulo}" enviada`, 'success');
            }
        }

        function guardarTemplate() {
            var titulo = document.getElementById('tituloTemplate').value.trim();
            var categoria = document.getElementById('categoriaTemplate').value;
            var mensaje = document.getElementById('mensajeTemplate').value.trim();
            var tipo = document.getElementById('tipoTemplate').value;
            
            if (!titulo || !mensaje) {
                showAlert('âš ï¸ Complete el tÃ­tulo y mensaje', 'error');
                return;
            }
            
            var templates = safeGetStorage('nvision_templates') || {};
            var templateId = Date.now().toString();
            
            templates[templateId] = {
                id: templateId,
                titulo: titulo,
                categoria: categoria,
                mensaje: mensaje,
                tipo: tipo,
                fechaCreacion: new Date().toISOString()
            };
            
            safeSetStorage('nvision_templates', templates);
            
            showAlert('âœ… Plantilla guardada exitosamente', 'success');
            cerrarModal('modalTemplate');
            cargarTemplatesPersonalizadas();
        }

        function previsualizarTemplate() {
            var mensaje = document.getElementById('mensajeTemplate').value.trim();
            if (!mensaje) {
                showAlert('âš ï¸ Escriba el mensaje primero', 'error');
                return;
            }
            
            alert('ğŸ“± Vista previa del mensaje:\n\n' + mensaje);
        }

        function cargarTemplatesPersonalizadas() {
            var templates = safeGetStorage('nvision_templates') || {};
            var grid = document.getElementById('templatesGrid');
            
            // Mantener templates predefinidas y agregar personalizadas
            var templateItems = grid.innerHTML;
            
            Object.keys(templates).forEach(function(key) {
                var template = templates[key];
                var preview = template.mensaje.substring(0, 60) + '...';
                
                templateItems += `
                    <div class="template-item" onclick="usarTemplatePersonalizada('${key}')">
                        <div class="template-title">${template.categoria} ${template.titulo}</div>
                        <div class="template-preview">${preview}</div>
                    </div>
                `;
            });
            
            grid.innerHTML = templateItems;
        }

        function usarTemplatePersonalizada(templateId) {
            var templates = safeGetStorage('nvision_templates') || {};
            var template = templates[templateId];
            
            if (template) {
                var whatsappUrl = `https://wa.me/?text=${encodeURIComponent(template.mensaje)}`;
                window.open(whatsappUrl, '_blank');
                showAlert(`âœ… Plantilla "${template.titulo}" enviada`, 'success');
            }
        }

        // FUNCIONES DE FACTURACIÃ“N RÃPIDA
        function generarFacturaRapida() {
            var cliente = document.getElementById('clienteFactura').value.trim();
            var telefono = document.getElementById('telefonoFactura').value.trim();
            var tipoComprobante = document.getElementById('tipoComprobanteFactura').value;
            var total = document.getElementById('totalFactura').value.trim();
            var descripcion = document.getElementById('descripcionFactura').value.trim();
            
            if (!cliente || !telefono || !total || !descripcion) {
                showAlert('âš ï¸ Complete todos los campos', 'error');
                return;
            }
            
            try {
                var numeroComprobante = null;
                var esSinNCF = tipoComprobante === 'sin_ncf';
                
                if (!esSinNCF) {
                    var comprobante = new ComprobanteNCF(tipoComprobante);
                    numeroComprobante = comprobante.usar();
                }
                
                var factura = {
                    id: 'FACT-' + Date.now(),
                    numeroComprobante: numeroComprobante,
                    sinNCF: esSinNCF,
                    esProforma: esSinNCF,
                    fecha: new Date().toLocaleDateString('es-DO'),
                    cliente: {
                        nombre: cliente,
                        telefono: telefono
                    },
                    total: total,
                    descripcion: descripcion,
                    tipoComprobante: tipoComprobante
                };
                
                // Guardar factura
                var facturas = safeGetStorage('nvision_facturas') || {};
                facturas[factura.id] = factura;
                safeSetStorage('nvision_facturas', facturas);
                
                if (esSinNCF) {
                    showAlert('âœ… Factura Proforma generada (Sin NCF)', 'success');
                    enviarProformaPorWhatsApp(factura);
                } else {
                    showAlert(`âœ… Factura generada: ${numeroComprobante}`, 'success');
                    enviarFacturaPorWhatsApp(factura);
                }
                
                cerrarModal('modalFacturacion');
                limpiarFormularioFacturacion();
                
            } catch (error) {
                console.error('Error generando factura:', error);
                showAlert('âŒ Error: ' + error.message, 'error');
            }
        }

        function enviarProformaPorWhatsApp(factura = null) {
                            if (!factura) {
                var cliente = document.getElementById('clienteFactura').value.trim();
                var telefono = document.getElementById('telefonoFactura').value.trim();
                var total = document.getElementById('totalFactura').value.trim();
                var descripcion = document.getElementById('descripcionFactura').value.trim();
                
                if (!cliente || !total) {
                    showAlert('âš ï¸ Complete los campos bÃ¡sicos', 'error');
                    return;
                }
                
                factura = {
                    cliente: { nombre: cliente, telefono: telefono },
                    total: total,
                    descripcion: descripcion,
                    fecha: new Date().toLocaleDateString('es-DO')
                };
            }
            
            var mensaje = plantillasWhatsApp.proforma.mensaje
                .replace('[CLIENTE]', factura.cliente.nombre)
                .replace('[TELEFONO]', factura.cliente.telefono)
                .replace('[FECHA]', factura.fecha)
                .replace('[PRODUCTOS]', factura.descripcion)
                .replace('[TOTAL]', factura.total);
            
            var whatsappUrl = `https://wa.me/${factura.cliente.telefono.replace(/[^0-9]/g, '')}?text=${encodeURIComponent(mensaje)}`;
            window.open(whatsappUrl, '_blank');
            
            showAlert('ğŸ“„ Factura Proforma enviada por WhatsApp', 'success');
        }

        function enviarFacturaPorWhatsApp(factura) {
            var mensaje = `ğŸ‘ï¸ *FACTURA - Ã“PTICA NVISIÃ“N* ğŸ‘ï¸

ğŸ“„ NCF: ${factura.numeroComprobante}
ğŸ“… Fecha: ${factura.fecha}
ğŸ‘¤ Cliente: ${factura.cliente.nombre}

ğŸ›ï¸ DescripciÃ³n: ${factura.descripcion}
ğŸ’° Total: ${factura.total}

âœ… Factura fiscal vÃ¡lida
ğŸ¤ Gracias por su confianza

ğŸ‘ï¸ Â¡Vea mejor, viva mejor! âœ¨
by fbrugaljrubinstein consultores`;
            
            var whatsappUrl = `https://wa.me/${factura.cliente.telefono.replace(/[^0-9]/g, '')}?text=${encodeURIComponent(mensaje)}`;
            window.open(whatsappUrl, '_blank');
        }

        function limpiarFormularioFacturacion() {
            document.getElementById('clienteFactura').value = '';
            document.getElementById('telefonoFactura').value = '';
            document.getElementById('totalFactura').value = '';
            document.getElementById('descripcionFactura').value = '';
            document.getElementById('tipoComprobanteFactura').value = 'sin_ncf';
        }

        // FUNCIONES DE AUDIO/VOZ
        function iniciarGrabacion() {
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                showAlert('âŒ Su navegador no soporta grabaciÃ³n de audio', 'error');
                return;
            }
            
            navigator.mediaDevices.getUserMedia({ audio: true })
                .then(function(stream) {
                    mediaRecorder = new MediaRecorder(stream);
                    audioChunks = [];
                    
                    mediaRecorder.ondataavailable = function(event) {
                        audioChunks.push(event.data);
                    };
                    
                    mediaRecorder.onstop = function() {
                        audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                        var audioUrl = URL.createObjectURL(audioBlob);
                        document.getElementById('audioPlayback').src = audioUrl;
                        document.getElementById('audioPlayback').style.display = 'block';
                        document.getElementById('btnEnviar').style.display = 'block';
                        stream.getTracks().forEach(track => track.stop());
                    };
                    
                    mediaRecorder.start();
                    
                    document.getElementById('btnGrabar').style.display = 'none';
                    document.getElementById('btnDetener').style.display = 'block';
                    document.getElementById('vozStatus').textContent = 'Grabando...';
                    document.getElementById('vozIcon').textContent = 'ğŸ”´';
                })
                .catch(function(error) {
                    console.error('Error accediendo al micrÃ³fono:', error);
                    showAlert('âŒ No se puede acceder al micrÃ³fono', 'error');
                });
        }

        function detenerGrabacion() {
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.stop();
                document.getElementById('btnGrabar').style.display = 'block';
                document.getElementById('btnDetener').style.display = 'none';
                document.getElementById('vozStatus').textContent = 'GrabaciÃ³n completada';
                document.getElementById('vozIcon').textContent = 'âœ…';
            }
        }

        function enviarNotaVoz() {
            if (!audioBlob) {
                showAlert('âŒ No hay audio grabado', 'error');
                return;
            }
            
            var mensaje = `ğŸ‘ï¸ *NOTA DE VOZ - Ã“PTICA NVISIÃ“N* ğŸ‘ï¸

ğŸ¤ He enviado una nota de voz desde el sistema centralizado.

ğŸŒ¾ Desde zona rural/humanitaria
â° Hora: ${new Date().toLocaleString('es-DO')}

ğŸ“ Por favor escuchen el audio y respondan lo antes posible.

ğŸ‘ï¸ Â¡Vea mejor, viva mejor! âœ¨
by fbrugaljrubinstein consultores`;
            
            var whatsappUrl = `https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(mensaje)}`;
            window.open(whatsappUrl, '_blank');
            
            showAlert('ğŸ¤ Nota de voz enviada (el audio debe enviarse manualmente)', 'success');
            cerrarModal('modalVoz');
        }

        // FUNCIONES PRINCIPALES
        function activarModoRural() {
            showAlert('ğŸŒ¾ Modo Rural activado - Funciones simplificadas disponibles', 'success');
            // Activar funciones especÃ­ficas para zona rural
            var features = document.querySelectorAll('.feature-btn');
            features.forEach(btn => {
                btn.style.fontSize = '14px';
                btn.style.padding = '18px 12px';
            });
        }

        function compartirUbicacion() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(position) {
                    var lat = position.coords.latitude;
                    var lon = position.coords.longitude;
                    var mensaje = `ğŸ‘ï¸ *MI UBICACIÃ“N - Ã“PTICA NVISIÃ“N* ğŸ‘ï¸

ğŸ“ Mi ubicaciÃ³n actual:
Latitud: ${lat}
Longitud: ${lon}

ğŸ—ºï¸ Ver en Google Maps:
https://maps.google.com/?q=${lat},${lon}

ğŸŒ¾ Desde zona rural/humanitaria
â° ${new Date().toLocaleString('es-DO')}

ğŸ“ Necesito asistencia en esta ubicaciÃ³n
ğŸ†˜ Para emergencias o consultas

by fbrugaljrubinstein consultores`;
                    
                    var whatsappUrl = `https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(mensaje)}`;
                    window.open(whatsappUrl, '_blank');
                    
                    showAlert('ğŸ“ UbicaciÃ³n compartida por WhatsApp', 'success');
                }, function() {
                    showAlert('âŒ No se pudo obtener la ubicaciÃ³n', 'error');
                });
            } else {
                showAlert('âŒ Su dispositivo no soporta geolocalizaciÃ³n', 'error');
            }
        }

        function sincronizarTodo() {
            showAlert('ğŸ”„ Sincronizando datos...', 'success');
            
            try {
                if (isFirebaseConnected) {
                    sincronizarConFirebase();
                    showAlert('âœ… SincronizaciÃ³n con Firebase completada', 'success');
                } else {
                    showAlert('âš ï¸ Sin conexiÃ³n a Firebase. Datos guardados localmente.', 'error');
                }
            } catch (error) {
                console.error('Error en sincronizaciÃ³n:', error);
                showAlert('âŒ Error en sincronizaciÃ³n', 'error');
            }
        }

        async function sincronizarConFirebase() {
            if (!isFirebaseConnected) return;
            
            try {
                // Sincronizar monturas
                var monturas = safeGetStorage('nvision_monturas');
                if (Object.keys(monturas).length > 0) {
                    await database.ref('monturas').set(monturas);
                }
                
                // Sincronizar clientes
                var clientes = safeGetStorage('nvision_clientes');
                if (Object.keys(clientes).length > 0) {
                    await database.ref('clientes').set(clientes);
                }
                
                // Sincronizar facturas
                var facturas = safeGetStorage('nvision_facturas');
                if (Object.keys(facturas).length > 0) {
                    await database.ref('facturas').set(facturas);
                }
                
                console.log('âœ… SincronizaciÃ³n completada');
            } catch (error) {
                console.error('Error sincronizando:', error);
            }
        }

        function exportarDatos() {
            try {
                var allData = {
                    monturas: safeGetStorage('nvision_monturas'),
                    clientes: safeGetStorage('nvision_clientes'),
                    productos: safeGetStorage('nvision_productos'),
                    facturas: safeGetStorage('nvision_facturas'),
                    templates: safeGetStorage('nvision_templates'),
                    comprobantes: safeGetStorage('nvision_comprobantes'),
                    estadisticas: {
                        views: localStorage.getItem('nvision_views') || '0',
                        clicks: localStorage.getItem('nvision_whatsapp_clicks') || '0'
                    },
                    export_info: {
                        timestamp: new Date().toISOString(),
                        version: '3.0',
                        sistema: 'Nvision_Central',
                        by: 'fbrugaljrubinstein consultores'
                    }
                };

                var blob = new Blob([JSON.stringify(allData, null, 2)], {type: 'application/json'});
                var url = URL.createObjectURL(blob);
                var a = document.createElement('a');
                a.href = url;
                a.download = 'nvision_export_' + new Date().toISOString().split('T')[0] + '.json';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showAlert('âœ… Datos exportados exitosamente', 'success');
            } catch (error) {
                console.error('Error exportando:', error);
                showAlert('âŒ Error al exportar datos', 'error');
            }
        }

        function resetSystem() {
            if (confirm('âš ï¸ Â¿EstÃ¡ seguro de resetear todo el sistema?\n\nEsto eliminarÃ¡ todos los datos locales.')) {
                try {
                    localStorage.clear();
                    showAlert('ğŸ”„ Sistema reseteado completamente', 'success');
                    setTimeout(() => window.location.reload(), 2000);
                } catch (error) {
                    showAlert('âŒ Error al resetear', 'error');
                }
            }
        }

        // INICIALIZACIÃ“N
        function inicializarCentral() {
            try {
                initFirebase();
                cargarTemplatesPersonalizadas();
                
                // Verificar modo rural automÃ¡tico
                var userAgent = navigator.userAgent.toLowerCase();
                var isLowEnd = userAgent.includes('android 4') || userAgent.includes('opera mini');
                
                if (isLowEnd) {
                    setTimeout(() => {
                        if (confirm('ğŸŒ¾ Â¿Activar modo rural simplificado para mejor rendimiento?')) {
                            activarModoRural();
                        }
                    }, 3000);
                }
                
                showAlert('âœ… Sistema Central inicializado correctamente', 'success');
                
            } catch (error) {
                console.error('Error inicializando central:', error);
                showAlert('âš ï¸ Error en inicializaciÃ³n. Algunas funciones pueden no estar disponibles.', 'error');
            }
        }

        // Event listeners
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', inicializarCentral);
        } else {
            inicializarCentral();
        }

        // Cerrar modales al hacer clic fuera
        window.addEventListener('click', function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        });

        // Evitar zoom en mÃ³viles
        document.addEventListener('touchstart', function(event) {
            if (event.touches.length > 1) {
                event.preventDefault();
            }
        }, { passive: false });

        var lastTouchEnd = 0;
        document.addEventListener('touchend', function(event) {
            var now = (new Date()).getTime();
            if (now - lastTouchEnd <= 300) {
                event.preventDefault();
            }
            lastTouchEnd = now;
        }, false);
    </script>
</body>
</html>